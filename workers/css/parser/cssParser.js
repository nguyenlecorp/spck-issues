!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","./cssScanner","./cssNodes","./cssErrors","../services/languageFacts"],e)}(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=e("./cssScanner"),a=e("./cssNodes"),p=e("./cssErrors"),r=e("../services/languageFacts"),i=function(){function e(e){void 0===e&&(e=new o.Scanner),this.keyframeRegex=/^@(\-(webkit|ms|moz|o)\-)?keyframes$/i,this.scanner=e,this.token=null,this.prevToken=null}return e.prototype.peekIdent=function(e){return o.TokenType.Ident===this.token.type&&e.length===this.token.text.length&&e===this.token.text.toLowerCase()},e.prototype.peekKeyword=function(e){return o.TokenType.AtKeyword===this.token.type&&e.length===this.token.text.length&&e===this.token.text.toLowerCase()},e.prototype.peekDelim=function(e){return o.TokenType.Delim===this.token.type&&e===this.token.text},e.prototype.peek=function(e){return e===this.token.type},e.prototype.peekRegExp=function(e,t){return e===this.token.type&&t.test(this.token.text)},e.prototype.hasWhitespace=function(){return this.prevToken&&this.prevToken.offset+this.prevToken.len!==this.token.offset},e.prototype.consumeToken=function(){this.prevToken=this.token,this.token=this.scanner.scan()},e.prototype.mark=function(){return{prev:this.prevToken,curr:this.token,pos:this.scanner.pos()}},e.prototype.restoreAtMark=function(e){this.prevToken=e.prev,this.token=e.curr,this.scanner.goBackTo(e.pos)},e.prototype.try=function(e){var t=this.mark(),r=e();return r||(this.restoreAtMark(t),null)},e.prototype.acceptOneKeyword=function(e){if(o.TokenType.AtKeyword===this.token.type)for(var t=0,r=e;t<r.length;t++){var i=r[t];if(i.length===this.token.text.length&&i===this.token.text.toLowerCase())return this.consumeToken(),!0}return!1},e.prototype.accept=function(e){return e===this.token.type&&(this.consumeToken(),!0)},e.prototype.acceptIdent=function(e){return!!this.peekIdent(e)&&(this.consumeToken(),!0)},e.prototype.acceptKeyword=function(e){return!!this.peekKeyword(e)&&(this.consumeToken(),!0)},e.prototype.acceptDelim=function(e){return!!this.peekDelim(e)&&(this.consumeToken(),!0)},e.prototype.acceptUnquotedString=function(){var e=this.scanner.pos();this.scanner.goBackTo(this.token.offset);var t=this.scanner.scanUnquotedString();return t?(this.token=t,this.consumeToken(),!0):(this.scanner.goBackTo(e),!1)},e.prototype.resync=function(e,t){for(;;){if(e&&-1!==e.indexOf(this.token.type))return this.consumeToken(),!0;if(t&&-1!==t.indexOf(this.token.type))return!0;if(this.token.type===o.TokenType.EOF)return!1;this.token=this.scanner.scan()}},e.prototype.createNode=function(e){return new a.Node(this.token.offset,this.token.len,e)},e.prototype.create=function(e){var t=Object.create(e.prototype);return e.apply(t,[this.token.offset,this.token.len]),t},e.prototype.finish=function(e,t,r,i){if(!(e instanceof a.Nodelist)&&(t&&this.markError(e,t,r,i),null!==this.prevToken)){var s=this.prevToken.offset+this.prevToken.len;e.length=s>e.offset?s-e.offset:0}return e},e.prototype.markError=function(e,t,r,i){this.token!==this.lastErrorToken&&(e.addIssue(new a.Marker(e,t,a.Level.Error,null,this.token.offset,this.token.len)),this.lastErrorToken=this.token),(r||i)&&this.resync(r,i)},e.prototype.parseStylesheet=function(r){var i=r.version;return this.internalParse(r.getText(),this._parseStylesheet,function(e,t){if(r.version!==i)throw new Error("Underlying model has changed, AST is no longer valid");return r.getText().substr(e,t)})},e.prototype.internalParse=function(r,e,t){this.scanner.setSource(r),this.token=this.scanner.scan();var i=e.bind(this)();return i&&(i.textProvider=t||function(e,t){return r.substr(e,t)}),i},e.prototype._parseStylesheet=function(){var e=this.create(a.Stylesheet);e.addChild(this._parseCharset());var t=!1;do{var r=!1;do{r=!1;var i=this._parseStylesheetStatement();for(i&&(e.addChild(i),t=!(r=!0),this.peek(o.TokenType.EOF)||!this._needsSemicolonAfter(i)||this.accept(o.TokenType.SemiColon)||this.markError(e,p.ParseError.SemiColonExpected));this.accept(o.TokenType.SemiColon)||this.accept(o.TokenType.CDO)||this.accept(o.TokenType.CDC);)t=!(r=!0)}while(r);if(this.peek(o.TokenType.EOF))break;t||(this.peek(o.TokenType.AtKeyword)?this.markError(e,p.ParseError.UnknownAtRule):this.markError(e,p.ParseError.RuleOrSelectorExpected),t=!0),this.consumeToken()}while(!this.peek(o.TokenType.EOF));return this.finish(e)},e.prototype._parseStylesheetStatement=function(){return this.peek(o.TokenType.AtKeyword)?this._parseImport()||this._parseMedia()||this._parsePage()||this._parseFontFace()||this._parseKeyframe()||this._parseSupports()||this._parseViewPort()||this._parseNamespace()||this._parseDocument():this._parseRuleset(!1)},e.prototype._tryParseRuleset=function(e){var t=this.mark();if(this._parseSelector(e)){for(;this.accept(o.TokenType.Comma)&&this._parseSelector(e););if(this.accept(o.TokenType.CurlyL))return this.restoreAtMark(t),this._parseRuleset(e)}return this.restoreAtMark(t),null},e.prototype._parseRuleset=function(e){void 0===e&&(e=!1);var t=this.create(a.RuleSet);if(!t.getSelectors().addChild(this._parseSelector(e)))return null;for(;this.accept(o.TokenType.Comma)&&t.getSelectors().addChild(this._parseSelector(e)););return this._parseBody(t,this._parseRuleSetDeclaration.bind(this))},e.prototype._parseRuleSetDeclaration=function(){return this._parseAtApply()||this._tryParseCustomPropertyDeclaration()||this._parseDeclaration()},e.prototype._parseAtApply=function(){if(!this.peekKeyword("@apply"))return null;var e=this.create(a.AtApplyRule);return this.consumeToken(),e.setIdentifier(this._parseIdent([a.ReferenceType.Variable]))?this.finish(e):this.finish(e,p.ParseError.IdentifierExpected)},e.prototype._needsSemicolonAfter=function(e){switch(e.type){case a.NodeType.Keyframe:case a.NodeType.ViewPort:case a.NodeType.Media:case a.NodeType.Ruleset:case a.NodeType.Namespace:case a.NodeType.If:case a.NodeType.For:case a.NodeType.Each:case a.NodeType.While:case a.NodeType.MixinDeclaration:case a.NodeType.FunctionDeclaration:return!1;case a.NodeType.VariableDeclaration:case a.NodeType.ExtendsReference:case a.NodeType.MixinContent:case a.NodeType.ReturnStatement:case a.NodeType.MediaQuery:case a.NodeType.Debug:case a.NodeType.Import:case a.NodeType.AtApplyRule:case a.NodeType.CustomPropertyDeclaration:return!0;case a.NodeType.MixinReference:return!e.getContent();case a.NodeType.Declaration:return!e.getNestedProperties()}return!1},e.prototype._parseDeclarations=function(e){var t=this.create(a.Declarations);if(!this.accept(o.TokenType.CurlyL))return null;for(var r=e();t.addChild(r)&&!this.peek(o.TokenType.CurlyR);){if(this._needsSemicolonAfter(r)&&!this.accept(o.TokenType.SemiColon))return this.finish(t,p.ParseError.SemiColonExpected,[o.TokenType.SemiColon,o.TokenType.CurlyR]);for(;this.accept(o.TokenType.SemiColon););r=e()}return this.accept(o.TokenType.CurlyR)?this.finish(t):this.finish(t,p.ParseError.RightCurlyExpected,[o.TokenType.CurlyR,o.TokenType.SemiColon])},e.prototype._parseBody=function(e,t){return e.setDeclarations(this._parseDeclarations(t))?this.finish(e):this.finish(e,p.ParseError.LeftCurlyExpected,[o.TokenType.CurlyR,o.TokenType.SemiColon])},e.prototype._parseSelector=function(e){var t=this.create(a.Selector),r=!1;for(e&&(r=t.addChild(this._parseCombinator()));t.addChild(this._parseSimpleSelector());)r=!0,t.addChild(this._parseCombinator());return r?this.finish(t):null},e.prototype._parseDeclaration=function(e){var t=this.create(a.Declaration);return t.setProperty(this._parseProperty())?this.accept(o.TokenType.Colon)?(t.colonPosition=this.prevToken.offset,t.setValue(this._parseExpr())?(t.addChild(this._parsePrio()),this.peek(o.TokenType.SemiColon)&&(t.semicolonPosition=this.token.offset),this.finish(t)):this.finish(t,p.ParseError.PropertyValueExpected)):this.finish(t,p.ParseError.ColonExpected,[o.TokenType.Colon],e):null},e.prototype._tryParseCustomPropertyDeclaration=function(){if(!this.peekRegExp(o.TokenType.Ident,/^--/))return null;var e=this.create(a.CustomPropertyDeclaration);if(!e.setProperty(this._parseProperty()))return null;if(!this.accept(o.TokenType.Colon))return this.finish(e,p.ParseError.ColonExpected,[o.TokenType.Colon]);e.colonPosition=this.prevToken.offset;var t=this.mark();if(this.peek(o.TokenType.CurlyL)){var r=this.create(a.CustomPropertySet),i=this._parseDeclarations(this._parseRuleSetDeclaration.bind(this));if(r.setDeclarations(i)&&!i.isErroneous(!0)&&(r.addChild(this._parsePrio()),this.peek(o.TokenType.SemiColon)))return this.finish(r),e.setPropertySet(r),e.semicolonPosition=this.token.offset,this.finish(e);this.restoreAtMark(t)}var s=this._parseExpr();return s&&!s.isErroneous(!0)&&(this._parsePrio(),this.peek(o.TokenType.SemiColon))?(e.setValue(s),e.semicolonPosition=this.token.offset,this.finish(e)):(this.restoreAtMark(t),e.addChild(this._parseCustomPropertyValue()),e.addChild(this._parsePrio()),this.token.offset===e.colonPosition+1?this.finish(e,p.ParseError.PropertyValueExpected):this.finish(e))},e.prototype._parseCustomPropertyValue=function(){var e=this.create(a.Node),t=function(){return 0===r&&0===i&&0===s},r=0,i=0,s=0;e:for(;;){switch(this.token.type){case o.TokenType.SemiColon:case o.TokenType.Exclamation:if(t())break e;break;case o.TokenType.CurlyL:r++;break;case o.TokenType.CurlyR:if(--r<0){if(0===i&&0===s)break e;return this.finish(e,p.ParseError.LeftCurlyExpected)}break;case o.TokenType.ParenthesisL:i++;break;case o.TokenType.ParenthesisR:if(--i<0)return this.finish(e,p.ParseError.LeftParenthesisExpected);break;case o.TokenType.BracketL:s++;break;case o.TokenType.BracketR:if(--s<0)return this.finish(e,p.ParseError.LeftSquareBracketExpected);break;case o.TokenType.BadString:break e;case o.TokenType.EOF:var n=p.ParseError.RightCurlyExpected;return 0<s?n=p.ParseError.RightSquareBracketExpected:0<i&&(n=p.ParseError.RightParenthesisExpected),this.finish(e,n)}this.consumeToken()}return this.finish(e)},e.prototype._tryToParseDeclaration=function(){var e=this.mark();return this._parseProperty()&&this.accept(o.TokenType.Colon)?(this.restoreAtMark(e),this._parseDeclaration()):(this.restoreAtMark(e),null)},e.prototype._parseProperty=function(){var e=this.create(a.Property),t=this.mark();return(this.acceptDelim("*")||this.acceptDelim("_"))&&this.hasWhitespace()?(this.restoreAtMark(t),null):e.setIdentifier(this._parsePropertyIdentifier())?this.finish(e):null},e.prototype._parsePropertyIdentifier=function(){return this._parseIdent()},e.prototype._parseCharset=function(){if(!this.peek(o.TokenType.Charset))return null;var e=this.create(a.Node);return this.consumeToken(),this.accept(o.TokenType.String)?this.accept(o.TokenType.SemiColon)?this.finish(e):this.finish(e,p.ParseError.SemiColonExpected):this.finish(e,p.ParseError.IdentifierExpected)},e.prototype._parseImport=function(){if(!this.peekKeyword("@import"))return null;var e=this.create(a.Import);return this.consumeToken(),e.addChild(this._parseURILiteral())||e.addChild(this._parseStringLiteral())?(this.peek(o.TokenType.SemiColon)||this.peek(o.TokenType.EOF)||e.setMedialist(this._parseMediaQueryList()),this.finish(e)):this.finish(e,p.ParseError.URIOrStringExpected)},e.prototype._parseNamespace=function(){if(!this.peekKeyword("@namespace"))return null;var e=this.create(a.Namespace);return this.consumeToken(),e.addChild(this._parseURILiteral())||(e.addChild(this._parseIdent()),e.addChild(this._parseURILiteral())||e.addChild(this._parseStringLiteral()))?this.accept(o.TokenType.SemiColon)?this.finish(e):this.finish(e,p.ParseError.SemiColonExpected):this.finish(e,p.ParseError.URIExpected,[o.TokenType.SemiColon])},e.prototype._parseFontFace=function(){if(!this.peekKeyword("@font-face"))return null;var e=this.create(a.FontFace);return this.consumeToken(),this._parseBody(e,this._parseRuleSetDeclaration.bind(this))},e.prototype._parseViewPort=function(){if(!this.peekKeyword("@-ms-viewport")&&!this.peekKeyword("@-o-viewport")&&!this.peekKeyword("@viewport"))return null;var e=this.create(a.ViewPort);return this.consumeToken(),this._parseBody(e,this._parseRuleSetDeclaration.bind(this))},e.prototype._parseKeyframe=function(){if(!this.peekRegExp(o.TokenType.AtKeyword,this.keyframeRegex))return null;var e=this.create(a.Keyframe),t=this.create(a.Node);return this.consumeToken(),e.setKeyword(this.finish(t)),"@-ms-keyframes"===t.getText()&&this.markError(t,p.ParseError.UnknownKeyword),e.setIdentifier(this._parseKeyframeIdent())?this._parseBody(e,this._parseKeyframeSelector.bind(this)):this.finish(e,p.ParseError.IdentifierExpected,[o.TokenType.CurlyR])},e.prototype._parseKeyframeIdent=function(){return this._parseIdent([a.ReferenceType.Keyframe])},e.prototype._parseKeyframeSelector=function(){var e=this.create(a.KeyframeSelector);if(!e.addChild(this._parseIdent())&&!this.accept(o.TokenType.Percentage))return null;for(;this.accept(o.TokenType.Comma);)if(!e.addChild(this._parseIdent())&&!this.accept(o.TokenType.Percentage))return this.finish(e,p.ParseError.PercentageExpected);return this._parseBody(e,this._parseRuleSetDeclaration.bind(this))},e.prototype._tryParseKeyframeSelector=function(){var e=this.create(a.KeyframeSelector),t=this.mark();if(!e.addChild(this._parseIdent())&&!this.accept(o.TokenType.Percentage))return null;for(;this.accept(o.TokenType.Comma);)if(!e.addChild(this._parseIdent())&&!this.accept(o.TokenType.Percentage))return this.restoreAtMark(t),null;return this.peek(o.TokenType.CurlyL)?this._parseBody(e,this._parseRuleSetDeclaration.bind(this)):(this.restoreAtMark(t),null)},e.prototype._parseSupports=function(e){if(void 0===e&&(e=!1),!this.peekKeyword("@supports"))return null;var t=this.create(a.Supports);return this.consumeToken(),t.addChild(this._parseSupportsCondition()),this._parseBody(t,this._parseSupportsDeclaration.bind(this,e))},e.prototype._parseSupportsDeclaration=function(e){return void 0===e&&(e=!1),e&&(this._tryParseRuleset(e)||this._tryToParseDeclaration())||this._parseStylesheetStatement()},e.prototype._parseSupportsCondition=function(){var e=this.create(a.SupportsCondition);if(this.acceptIdent("not"))e.addChild(this._parseSupportsConditionInParens());else if(e.addChild(this._parseSupportsConditionInParens()),this.peekRegExp(o.TokenType.Ident,/^(and|or)$/i))for(var t=this.token.text;this.acceptIdent(t);)e.addChild(this._parseSupportsConditionInParens());return this.finish(e)},e.prototype._parseSupportsConditionInParens=function(){var e=this.create(a.SupportsCondition);if(this.accept(o.TokenType.ParenthesisL))return e.lParent=this.prevToken.offset,e.addChild(this._tryToParseDeclaration())||this._parseSupportsCondition()?this.accept(o.TokenType.ParenthesisR)?(e.rParent=this.prevToken.offset,this.finish(e)):this.finish(e,p.ParseError.RightParenthesisExpected,[o.TokenType.ParenthesisR],[]):this.finish(e,p.ParseError.ConditionExpected);if(this.peek(o.TokenType.Ident)){var t=this.mark();if(this.consumeToken(),!this.hasWhitespace()&&this.accept(o.TokenType.ParenthesisL)){for(var r=1;this.token.type!==o.TokenType.EOF&&0!==r;)this.token.type===o.TokenType.ParenthesisL?r++:this.token.type===o.TokenType.ParenthesisR&&r--,this.consumeToken();return this.finish(e)}this.restoreAtMark(t)}return this.finish(e,p.ParseError.LeftParenthesisExpected,[],[o.TokenType.ParenthesisL])},e.prototype._parseMediaDeclaration=function(e){return void 0===e&&(e=!1),this._tryParseRuleset(e)||this._tryToParseDeclaration()||this._parseStylesheetStatement()},e.prototype._parseMedia=function(e){if(void 0===e&&(e=!1),!this.peekKeyword("@media"))return null;var t=this.create(a.Media);return this.consumeToken(),t.addChild(this._parseMediaQueryList())?this._parseBody(t,this._parseMediaDeclaration.bind(this,e)):this.finish(t,p.ParseError.MediaQueryExpected)},e.prototype._parseMediaQueryList=function(){var e=this.create(a.Medialist);if(!e.addChild(this._parseMediaQuery([o.TokenType.CurlyL])))return this.finish(e,p.ParseError.MediaQueryExpected);for(;this.accept(o.TokenType.Comma);)if(!e.addChild(this._parseMediaQuery([o.TokenType.CurlyL])))return this.finish(e,p.ParseError.MediaQueryExpected);return this.finish(e)},e.prototype._parseMediaQuery=function(e){var t=this.create(a.MediaQuery),r=!0,i=!1;if(!this.peek(o.TokenType.ParenthesisL)){if(this.acceptIdent("only")||this.acceptIdent("not"),!t.addChild(this._parseIdent()))return null;i=!0,r=this.acceptIdent("and")}for(;r;){if(!this.accept(o.TokenType.ParenthesisL))return i?this.finish(t,p.ParseError.LeftParenthesisExpected,[],e):null;if(!t.addChild(this._parseMediaFeatureName()))return this.finish(t,p.ParseError.IdentifierExpected,[],e);if(this.accept(o.TokenType.Colon)&&!t.addChild(this._parseExpr()))return this.finish(t,p.ParseError.TermExpected,[],e);if(!this.accept(o.TokenType.ParenthesisR))return this.finish(t,p.ParseError.RightParenthesisExpected,[],e);r=this.acceptIdent("and")}return this.finish(t)},e.prototype._parseMediaFeatureName=function(){return this._parseIdent()},e.prototype._parseMedium=function(){var e=this.create(a.Node);return e.addChild(this._parseIdent())?this.finish(e):null},e.prototype._parsePageDeclaration=function(){return this._parsePageMarginBox()||this._parseRuleSetDeclaration()},e.prototype._parsePage=function(){if(!this.peekKeyword("@page"))return null;var e=this.create(a.Page);if(this.consumeToken(),e.addChild(this._parsePageSelector()))for(;this.accept(o.TokenType.Comma);)if(!e.addChild(this._parsePageSelector()))return this.finish(e,p.ParseError.IdentifierExpected);return this._parseBody(e,this._parsePageDeclaration.bind(this))},e.prototype._parsePageMarginBox=function(){if(!this.peek(o.TokenType.AtKeyword))return null;var e=this.create(a.PageBoxMarginBox);return this.acceptOneKeyword(r.getPageBoxDirectives())||this.markError(e,p.ParseError.UnknownAtRule,[],[o.TokenType.CurlyL]),this._parseBody(e,this._parseRuleSetDeclaration.bind(this))},e.prototype._parsePageSelector=function(){if(!this.peek(o.TokenType.Ident)&&!this.peek(o.TokenType.Colon))return null;var e=this.create(a.Node);return e.addChild(this._parseIdent()),this.accept(o.TokenType.Colon)&&!e.addChild(this._parseIdent())?this.finish(e,p.ParseError.IdentifierExpected):this.finish(e)},e.prototype._parseDocument=function(){if(!this.peekKeyword("@-moz-document"))return null;var e=this.create(a.Document);return this.consumeToken(),this.resync([],[o.TokenType.CurlyL]),this._parseBody(e,this._parseStylesheetStatement.bind(this))},e.prototype._parseOperator=function(){if(this.peekDelim("/")||this.peekDelim("*")||this.peekDelim("+")||this.peekDelim("-")||this.peek(o.TokenType.Dashmatch)||this.peek(o.TokenType.Includes)||this.peek(o.TokenType.SubstringOperator)||this.peek(o.TokenType.PrefixOperator)||this.peek(o.TokenType.SuffixOperator)||this.peekDelim("=")){var e=this.createNode(a.NodeType.Operator);return this.consumeToken(),this.finish(e)}return null},e.prototype._parseUnaryOperator=function(){if(!this.peekDelim("+")&&!this.peekDelim("-"))return null;var e=this.create(a.Node);return this.consumeToken(),this.finish(e)},e.prototype._parseCombinator=function(){if(this.peekDelim(">")){var e=this.create(a.Node);this.consumeToken();var t=this.mark();if(!this.hasWhitespace()&&this.acceptDelim(">")){if(!this.hasWhitespace()&&this.acceptDelim(">"))return e.type=a.NodeType.SelectorCombinatorShadowPiercingDescendant,this.finish(e);this.restoreAtMark(t)}return e.type=a.NodeType.SelectorCombinatorParent,this.finish(e)}if(this.peekDelim("+")){e=this.create(a.Node);return this.consumeToken(),e.type=a.NodeType.SelectorCombinatorSibling,this.finish(e)}if(this.peekDelim("~")){e=this.create(a.Node);return this.consumeToken(),e.type=a.NodeType.SelectorCombinatorAllSiblings,this.finish(e)}if(!this.peekDelim("/"))return null;e=this.create(a.Node);this.consumeToken();t=this.mark();if(!this.hasWhitespace()&&this.acceptIdent("deep")&&!this.hasWhitespace()&&this.acceptDelim("/"))return e.type=a.NodeType.SelectorCombinatorShadowPiercingDescendant,this.finish(e);this.restoreAtMark(t)},e.prototype._parseSimpleSelector=function(){var e=this.create(a.SimpleSelector),t=0;for(e.addChild(this._parseElementName())&&t++;(0===t||!this.hasWhitespace())&&e.addChild(this._parseSimpleSelectorBody());)t++;return 0<t?this.finish(e):null},e.prototype._parseSimpleSelectorBody=function(){return this._parsePseudo()||this._parseHash()||this._parseClass()||this._parseAttrib()},e.prototype._parseSelectorIdent=function(){return this._parseIdent()},e.prototype._parseHash=function(){if(!this.peek(o.TokenType.Hash)&&!this.peekDelim("#"))return null;var e=this.createNode(a.NodeType.IdentifierSelector);if(this.acceptDelim("#")){if(this.hasWhitespace()||!e.addChild(this._parseSelectorIdent()))return this.finish(e,p.ParseError.IdentifierExpected)}else this.consumeToken();return this.finish(e)},e.prototype._parseClass=function(){if(!this.peekDelim("."))return null;var e=this.createNode(a.NodeType.ClassSelector);return this.consumeToken(),this.hasWhitespace()||!e.addChild(this._parseSelectorIdent())?this.finish(e,p.ParseError.IdentifierExpected):this.finish(e)},e.prototype._parseElementName=function(){var e=this.mark(),t=this.createNode(a.NodeType.ElementNameSelector);return t.addChild(this._parseNamespacePrefix()),t.addChild(this._parseSelectorIdent())||this.acceptDelim("*")?this.finish(t):(this.restoreAtMark(e),null)},e.prototype._parseNamespacePrefix=function(){var e=this.mark(),t=this.createNode(a.NodeType.NamespacePrefix);return!t.addChild(this._parseIdent())&&this.acceptDelim("*"),this.acceptDelim("|")?this.finish(t):(this.restoreAtMark(e),null)},e.prototype._parseAttrib=function(){if(!this.peek(o.TokenType.BracketL))return null;var e=this.create(a.AttributeSelector);return this.consumeToken(),e.setNamespacePrefix(this._parseNamespacePrefix()),e.setExpression(this._parseBinaryExpr()),this.accept(o.TokenType.BracketR)?this.finish(e):this.finish(e,p.ParseError.RightSquareBracketExpected)},e.prototype._parsePseudo=function(){var t=this;if(!this.peek(o.TokenType.Colon))return null;var e=this.mark(),r=this.createNode(a.NodeType.PseudoSelector);if(this.consumeToken(),this.hasWhitespace())return this.restoreAtMark(e),null;if(this.accept(o.TokenType.Colon)&&this.hasWhitespace())return this.finish(r,p.ParseError.IdentifierExpected);if(!r.addChild(this._parseIdent()))return this.finish(r,p.ParseError.IdentifierExpected);if(!this.hasWhitespace()&&this.accept(o.TokenType.ParenthesisL)){if(r.addChild(this.try(function(){var e=t._parseSimpleSelector();return e&&t.peek(o.TokenType.ParenthesisR)?e:null})||this._parseBinaryExpr()),!this.accept(o.TokenType.ParenthesisR))return this.finish(r,p.ParseError.RightParenthesisExpected)}return this.finish(r)},e.prototype._tryParsePrio=function(){var e=this.mark(),t=this._parsePrio();return t||(this.restoreAtMark(e),null)},e.prototype._parsePrio=function(){if(!this.peek(o.TokenType.Exclamation))return null;var e=this.createNode(a.NodeType.Prio);return this.accept(o.TokenType.Exclamation)&&this.acceptIdent("important")?this.finish(e):null},e.prototype._parseExpr=function(e){void 0===e&&(e=!1);var t=this.create(a.Expression);if(!t.addChild(this._parseNamedLine()||this._parseBinaryExpr()))return null;for(;;){if(this.peek(o.TokenType.Comma)){if(e)return this.finish(t);this.consumeToken()}if(!t.addChild(this._parseNamedLine()||this._parseBinaryExpr()))break}return this.finish(t)},e.prototype._parseNamedLine=function(){if(!this.peek(o.TokenType.BracketL))return null;var e=this.createNode(a.NodeType.GridLine);for(this.consumeToken();e.addChild(this._parseIdent()););return this.accept(o.TokenType.BracketR)?this.finish(e):this.finish(e,p.ParseError.RightSquareBracketExpected)},e.prototype._parseBinaryExpr=function(e,t){var r=this.create(a.BinaryExpression);if(!r.setLeft(e||this._parseTerm()))return null;if(!r.setOperator(t||this._parseOperator()))return this.finish(r);if(!r.setRight(this._parseTerm()))return this.finish(r,p.ParseError.TermExpected);r=this.finish(r);var i=this._parseOperator();return i&&(r=this._parseBinaryExpr(r,i)),this.finish(r)},e.prototype._parseTerm=function(){var e=this.create(a.Term);return e.setOperator(this._parseUnaryOperator()),e.setExpression(this._parseURILiteral())||e.setExpression(this._parseFunction())||e.setExpression(this._parseIdent())||e.setExpression(this._parseStringLiteral())||e.setExpression(this._parseNumeric())||e.setExpression(this._parseHexColor())||e.setExpression(this._parseOperation())?this.finish(e):null},e.prototype._parseOperation=function(){if(!this.peek(o.TokenType.ParenthesisL))return null;var e=this.create(a.Node);return this.consumeToken(),e.addChild(this._parseExpr()),this.accept(o.TokenType.ParenthesisR)?this.finish(e):this.finish(e,p.ParseError.RightParenthesisExpected)},e.prototype._parseNumeric=function(){if(this.peek(o.TokenType.Num)||this.peek(o.TokenType.Percentage)||this.peek(o.TokenType.Resolution)||this.peek(o.TokenType.Length)||this.peek(o.TokenType.EMS)||this.peek(o.TokenType.EXS)||this.peek(o.TokenType.Angle)||this.peek(o.TokenType.Time)||this.peek(o.TokenType.Dimension)||this.peek(o.TokenType.Freq)){var e=this.create(a.NumericValue);return this.consumeToken(),this.finish(e)}return null},e.prototype._parseStringLiteral=function(){if(!this.peek(o.TokenType.String)&&!this.peek(o.TokenType.BadString))return null;var e=this.createNode(a.NodeType.StringLiteral);return this.consumeToken(),this.finish(e)},e.prototype._parseURILiteral=function(){if(!this.peekRegExp(o.TokenType.Ident,/^url(-prefix)?$/i))return null;var e=this.mark(),t=this.createNode(a.NodeType.URILiteral);return this.accept(o.TokenType.Ident),this.hasWhitespace()||!this.peek(o.TokenType.ParenthesisL)?(this.restoreAtMark(e),null):(this.scanner.inURL=!0,this.consumeToken(),t.addChild(this._parseURLArgument()),this.scanner.inURL=!1,this.accept(o.TokenType.ParenthesisR)?this.finish(t):this.finish(t,p.ParseError.RightParenthesisExpected))},e.prototype._parseURLArgument=function(){var e=this.create(a.Node);return this.accept(o.TokenType.String)||this.accept(o.TokenType.BadString)||this.acceptUnquotedString()?this.finish(e):null},e.prototype._parseIdent=function(e){if(!this.peek(o.TokenType.Ident))return null;var t=this.create(a.Identifier);return e&&(t.referenceTypes=e),t.isCustomProperty=this.peekRegExp(o.TokenType.Ident,/^--/),this.consumeToken(),this.finish(t)},e.prototype._parseFunction=function(){var e=this.mark(),t=this.create(a.Function);if(!t.setIdentifier(this._parseFunctionIdentifier()))return null;if(this.hasWhitespace()||!this.accept(o.TokenType.ParenthesisL))return this.restoreAtMark(e),null;if(t.getArguments().addChild(this._parseFunctionArgument()))for(;this.accept(o.TokenType.Comma);)t.getArguments().addChild(this._parseFunctionArgument())||this.markError(t,p.ParseError.ExpressionExpected);return this.accept(o.TokenType.ParenthesisR)?this.finish(t):this.finish(t,p.ParseError.RightParenthesisExpected)},e.prototype._parseFunctionIdentifier=function(){if(!this.peek(o.TokenType.Ident))return null;var e=this.create(a.Identifier);if(e.referenceTypes=[a.ReferenceType.Function],this.acceptIdent("progid")){if(this.accept(o.TokenType.Colon))for(;this.accept(o.TokenType.Ident)&&this.acceptDelim("."););return this.finish(e)}return this.consumeToken(),this.finish(e)},e.prototype._parseFunctionArgument=function(){var e=this.create(a.FunctionArgument);return e.setValue(this._parseExpr(!0))?this.finish(e):null},e.prototype._parseHexColor=function(){if(this.peekRegExp(o.TokenType.Hash,/^#([A-Fa-f0-9]{3}|[A-Fa-f0-9]{4}|[A-Fa-f0-9]{6}|[A-Fa-f0-9]{8})$/g)){var e=this.create(a.HexColorValue);return this.consumeToken(),this.finish(e)}return null},e}();t.Parser=i});