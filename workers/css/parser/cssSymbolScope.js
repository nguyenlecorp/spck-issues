var __extends=this&&this.__extends||function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}}();!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","./cssNodes","../utils/arrays"],e)}(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p=e("./cssNodes"),i=e("../utils/arrays"),r=function(){function e(e,t){this.offset=e,this.length=t,this.symbols=[],this.parent=null,this.children=[]}return e.prototype.addChild=function(e){this.children.push(e),e.setParent(this)},e.prototype.setParent=function(e){this.parent=e},e.prototype.findScope=function(e,t){return void 0===t&&(t=0),this.offset<=e&&this.offset+this.length>e+t||this.offset===e&&this.length===t?this.findInScope(e,t):null},e.prototype.findInScope=function(e,t){void 0===t&&(t=0);var n=e+t,r=i.findFirst(this.children,function(e){return e.offset>n});if(0===r)return this;var o=this.children[r-1];return o.offset<=e&&o.offset+o.length>=e+t?o.findInScope(e,t):this},e.prototype.addSymbol=function(e){this.symbols.push(e)},e.prototype.getSymbol=function(e,t){for(var n=0;n<this.symbols.length;n++){var r=this.symbols[n];if(r.name===e&&r.type===t)return r}return null},e.prototype.getSymbols=function(){return this.symbols},e}(),n=function(e){function t(){return e.call(this,0,Number.MAX_VALUE)||this}return __extends(t,e),t}(t.Scope=r);t.GlobalScope=n;var a=function(e,t,n,r){this.name=e,this.value=t,this.node=n,this.type=r};t.Symbol=a;var o=function(){function e(e){this.scope=e}return e.prototype.addSymbol=function(e,t,n,r){-1!==e.offset&&this.scope.findScope(e.offset,e.length).addSymbol(new a(t,n,e,r))},e.prototype.addScope=function(e){if(-1!==e.offset){var t=this.scope.findScope(e.offset,e.length);if(t.offset!==e.offset||t.length!==e.length){var n=new r(e.offset,e.length);return t.addChild(n),n}return t}return null},e.prototype.addSymbolToChildScope=function(e,t,n,r,o){e&&-1!==e.offset&&this.addScope(e).addSymbol(new a(n,r,t,o))},e.prototype.visitNode=function(e){switch(e.type){case p.NodeType.Keyframe:return this.addSymbol(e,e.getName(),null,p.ReferenceType.Keyframe),!0;case p.NodeType.CustomPropertyDeclaration:return this.visitCustomPropertyDeclarationNode(e);case p.NodeType.VariableDeclaration:return this.visitVariableDeclarationNode(e);case p.NodeType.Ruleset:return this.visitRuleSet(e);case p.NodeType.MixinDeclaration:return this.addSymbol(e,e.getName(),null,p.ReferenceType.Mixin),!0;case p.NodeType.FunctionDeclaration:return this.addSymbol(e,e.getName(),null,p.ReferenceType.Function),!0;case p.NodeType.FunctionParameter:return this.visitFunctionParameterNode(e);case p.NodeType.Declarations:return this.addScope(e),!0;case p.NodeType.For:var t=e,n=t.getDeclarations();return n&&this.addSymbolToChildScope(n,t.variable,t.variable.getName(),null,p.ReferenceType.Variable),!0;case p.NodeType.Each:var r=e,o=r.getDeclarations();if(o)for(var i=0,a=r.getVariables().getChildren();i<a.length;i++){var l=a[i];this.addSymbolToChildScope(o,l,l.getName(),null,p.ReferenceType.Variable)}return!0}return!0},e.prototype.visitRuleSet=function(e){for(var t=this.scope.findScope(e.offset,e.length),n=0,r=e.getSelectors().getChildren();n<r.length;n++){var o=r[n];o instanceof p.Selector&&1===o.getChildren().length&&t.addSymbol(new a(o.getChild(0).getText(),null,o,p.ReferenceType.Rule))}return!0},e.prototype.visitVariableDeclarationNode=function(e){var t=e.getValue()?e.getValue().getText():null;return this.addSymbol(e,e.getName(),t,p.ReferenceType.Variable),!0},e.prototype.visitFunctionParameterNode=function(e){var t=e.getParent().getDeclarations();if(t){var n=e.getDefaultValue(),r=n?n.getText():null;this.addSymbolToChildScope(t,e,e.getName(),r,p.ReferenceType.Variable)}return!0},e.prototype.visitCustomPropertyDeclarationNode=function(e){var t=e.getValue()?e.getValue().getText():"";return this.addCSSVariable(e.getProperty(),e.getProperty().getName(),t,p.ReferenceType.Variable),!0},e.prototype.addCSSVariable=function(e,t,n,r){-1!==e.offset&&this.getGlobalScope(e,t,r).addSymbol(new a(t,n,e,r))},e.prototype.getGlobalScope=function(e,t,n){for(var r=this.scope.findScope(e.offset,e.length);null!==r.parent;)r=r.parent;return r},e}();t.ScopeBuilder=o;var l=function(){function e(e){this.global=new n,e.acceptVisitor(new o(this.global))}return e.prototype.findSymbolsAtOffset=function(e,t){for(var n=this.global.findScope(e,0),r=[],o={};n;){for(var i=n.getSymbols(),a=0;a<i.length;a++){var l=i[a];l.type!==t||o[l.name]||(r.push(l),o[l.name]=!0)}n=n.parent}return r},e.prototype.internalFindSymbol=function(e,t){var n=e;if(e.parent instanceof p.FunctionParameter&&e.parent.getParent()instanceof p.BodyDeclaration&&(n=e.parent.getParent().getDeclarations()),e.parent instanceof p.FunctionArgument&&e.parent.getParent()instanceof p.Function){var r=e.parent.getParent().getIdentifier();if(r){var o=this.internalFindSymbol(r,[p.ReferenceType.Function]);o&&(n=o.node.getDeclarations())}}if(!n)return null;for(var i=e.getText(),a=this.global.findScope(n.offset,n.length);a;){for(var l=0;l<t.length;l++){var s=t[l],f=a.getSymbol(i,s);if(f)return f}a=a.parent}return null},e.prototype.evaluateReferenceTypes=function(e){if(e instanceof p.Identifier){var t=e.referenceTypes;if(t)return t;if(e.isCustomProperty)return[p.ReferenceType.Variable];var n=p.getParentDeclaration(e);if(n){var r=n.getNonPrefixedPropertyName();if(("animation"===r||"animation-name"===r)&&n.getValue()&&n.getValue().offset===e.offset)return[p.ReferenceType.Keyframe]}}else if(e instanceof p.Variable)return[p.ReferenceType.Variable];return e.findParent(p.NodeType.Selector)?[p.ReferenceType.Rule]:e.findParent(p.NodeType.ExtendsReference)?[p.ReferenceType.Rule]:null},e.prototype.findSymbolFromNode=function(e){if(!e)return null;for(;e.type===p.NodeType.Interpolation;)e=e.getParent();var t=this.evaluateReferenceTypes(e);return t?this.internalFindSymbol(e,t):null},e.prototype.matchesSymbol=function(e,t){if(!e)return null;for(;e.type===p.NodeType.Interpolation;)e=e.getParent();if(t.name.length!==e.length||t.name!==e.getText())return!1;var n=this.evaluateReferenceTypes(e);return!(!n||-1===n.indexOf(t.type))&&this.internalFindSymbol(e,n)===t},e.prototype.findSymbol=function(e,t,n){for(var r=this.global.findScope(n);r;){var o=r.getSymbol(e,t);if(o)return o;r=r.parent}return null},e}();t.Symbols=l});