var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","./lessScanner","./cssScanner","./cssParser","./cssNodes","./cssErrors"],e)}(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=e("./lessScanner"),a=e("./cssScanner"),r=e("./cssParser"),o=e("./cssNodes"),p=e("./cssErrors"),i=function(i){function e(){return i.call(this,new s.LESSScanner)||this}return __extends(e,i),e.prototype._parseStylesheetStatement=function(){return this._tryParseMixinDeclaration()||this._tryParseMixinReference(!0)||i.prototype._parseStylesheetStatement.call(this)||this._parseVariableDeclaration()},e.prototype._parseImport=function(){if(!this.peekKeyword("@import")&&!this.peekKeyword("@import-once"))return null;var e=this.create(o.Import);if(this.consumeToken(),this.accept(a.TokenType.ParenthesisL)){if(!this.accept(a.TokenType.Ident))return this.finish(e,p.ParseError.IdentifierExpected,[a.TokenType.SemiColon]);do{if(!this.accept(a.TokenType.Comma))break}while(this.accept(a.TokenType.Ident));if(!this.accept(a.TokenType.ParenthesisR))return this.finish(e,p.ParseError.RightParenthesisExpected,[a.TokenType.SemiColon])}return e.addChild(this._parseURILiteral())||e.addChild(this._parseStringLiteral())?(this.peek(a.TokenType.SemiColon)||this.peek(a.TokenType.EOF)||e.setMedialist(this._parseMediaQueryList()),this.finish(e)):this.finish(e,p.ParseError.URIOrStringExpected,[a.TokenType.SemiColon])},e.prototype._parseMediaQuery=function(e){var t=i.prototype._parseMediaQuery.call(this,e);if(t)return t;var r=this.create(o.MediaQuery);return r.addChild(this._parseVariable())?this.finish(r):null},e.prototype._parseMediaDeclaration=function(e){return void 0===e&&(e=!1),this._tryParseRuleset(e)||this._tryToParseDeclaration()||this._tryParseMixinDeclaration()||this._tryParseMixinReference()||this._parseDetachedRuleSetMixin()||this._parseStylesheetStatement()},e.prototype._parseMediaFeatureName=function(){return this._parseIdent()||this._parseVariable()},e.prototype._parseVariableDeclaration=function(e){void 0===e&&(e=[]);var t=this.create(o.VariableDeclaration),r=this.mark();return t.setVariable(this._parseVariable())?this.accept(a.TokenType.Colon)?(t.colonPosition=this.prevToken.offset,t.setValue(this._parseDetachedRuleSet()||this._parseExpr())?(t.addChild(this._parsePrio()),this.peek(a.TokenType.SemiColon)&&(t.semicolonPosition=this.token.offset),this.finish(t)):this.finish(t,p.ParseError.VariableValueExpected,[],e)):(this.restoreAtMark(r),null):null},e.prototype._parseDetachedRuleSet=function(){if(!this.peek(a.TokenType.CurlyL))return null;var e=this.create(o.BodyDeclaration);return this._parseBody(e,this._parseDetachedRuleSetBody.bind(this)),this.finish(e)},e.prototype._parseDetachedRuleSetBody=function(){return this._tryParseKeyframeSelector()||i.prototype._parseRuleSetDeclaration.call(this)},e.prototype._parseVariable=function(){if(!this.peekDelim("@")&&!this.peek(a.TokenType.AtKeyword))return null;for(var e=this.create(o.Variable),t=this.mark();this.acceptDelim("@");)if(this.hasWhitespace())return this.restoreAtMark(t),null;return this.accept(a.TokenType.AtKeyword)?e:(this.restoreAtMark(t),null)},e.prototype._parseTerm=function(){var e=i.prototype._parseTerm.call(this);return e||((e=this.create(o.Term)).setExpression(this._parseVariable())||e.setExpression(this._parseEscaped())?this.finish(e):null)},e.prototype._parseEscaped=function(){if(this.peek(a.TokenType.EscapedJavaScript)||this.peek(a.TokenType.BadEscapedJavaScript)){var e=this.createNode(o.NodeType.EscapedValue);return this.consumeToken(),this.finish(e)}if(this.peekDelim("~")){e=this.createNode(o.NodeType.EscapedValue);return this.consumeToken(),this.finish(e,this.accept(a.TokenType.String)?null:p.ParseError.TermExpected)}return null},e.prototype._parseOperator=function(){var e=this._parseGuardOperator();return e||i.prototype._parseOperator.call(this)},e.prototype._parseGuardOperator=function(){if(this.peekDelim(">")){var e=this.createNode(o.NodeType.Operator);return this.consumeToken(),this.acceptDelim("="),e}if(this.peekDelim("=")){e=this.createNode(o.NodeType.Operator);return this.consumeToken(),this.acceptDelim("<"),e}if(this.peekDelim("<")){e=this.createNode(o.NodeType.Operator);return this.consumeToken(),this.acceptDelim("="),e}return null},e.prototype._parseRuleSetDeclaration=function(){return this.peek(a.TokenType.AtKeyword)?this._parseKeyframe()||this._parseMedia(!0)||this._parseImport()||this._parseSupports(!0)||this._parseDetachedRuleSetMixin()||this._parseVariableDeclaration():this._tryParseMixinDeclaration()||this._tryParseRuleset(!0)||this._tryParseMixinReference()||this._parseExtend()||i.prototype._parseRuleSetDeclaration.call(this)},e.prototype._parseKeyframeIdent=function(){return this._parseIdent([o.ReferenceType.Keyframe])||this._parseVariable()},e.prototype._parseKeyframeSelector=function(){return this._parseDetachedRuleSetMixin()||i.prototype._parseKeyframeSelector.call(this)},e.prototype._parseSimpleSelectorBody=function(){return this._parseSelectorCombinator()||i.prototype._parseSimpleSelectorBody.call(this)},e.prototype._parseSelector=function(e){var t=this.create(o.Selector),r=!1;for(e&&(r=t.addChild(this._parseCombinator()));t.addChild(this._parseSimpleSelector());){r=!0;var i=this.mark();if(t.addChild(this._parseGuard())&&this.peek(a.TokenType.CurlyL))break;this.restoreAtMark(i),t.addChild(this._parseCombinator())}return r?this.finish(t):null},e.prototype._parseSelectorCombinator=function(){if(this.peekDelim("&")){var e=this.createNode(o.NodeType.SelectorCombinator);for(this.consumeToken();!this.hasWhitespace()&&(this.acceptDelim("-")||this.accept(a.TokenType.Num)||this.accept(a.TokenType.Dimension)||e.addChild(this._parseIdent())||this.acceptDelim("&")););return this.finish(e)}return null},e.prototype._parseSelectorIdent=function(){if(!this.peekInterpolatedIdent())return null;var e=this.createNode(o.NodeType.SelectorInterpolation);return this._acceptInterpolatedIdent(e)?this.finish(e):null},e.prototype._parsePropertyIdentifier=function(){if(!this.peekInterpolatedIdent())return null;var e=this.create(o.Identifier);e.isCustomProperty=this.peekRegExp(a.TokenType.Ident,/^--/);var t=this._acceptInterpolatedIdent(e);return t&&!this.hasWhitespace()&&(this.acceptDelim("+"),this.hasWhitespace()||this.acceptIdent("_")),t?this.finish(e):null},e.prototype.peekInterpolatedIdent=function(){return this.peek(a.TokenType.Ident)||this.peekDelim("@")||this.peekDelim("-")},e.prototype._acceptInterpolatedIdent=function(e){for(var t=this,r=!1,i=function(){return t.acceptDelim("-")?(!t.hasWhitespace()&&t.acceptDelim("-"),t.hasWhitespace()?null:t._parseInterpolation()):null};(this.accept(a.TokenType.Ident)||e.addChild(this._parseInterpolation()||this.try(i)))&&(r=!0,!this.hasWhitespace()&&this.acceptDelim("-"),!this.hasWhitespace()););return r},e.prototype._parseInterpolation=function(){var e=this.mark();if(this.peekDelim("@")){var t=this.createNode(o.NodeType.Interpolation);return this.consumeToken(),this.hasWhitespace()||!this.accept(a.TokenType.CurlyL)?(this.restoreAtMark(e),null):t.addChild(this._parseIdent())?this.accept(a.TokenType.CurlyR)?this.finish(t):this.finish(t,p.ParseError.RightCurlyExpected):this.finish(t,p.ParseError.IdentifierExpected)}return null},e.prototype._tryParseMixinDeclaration=function(){var e=this.mark(),t=this.create(o.MixinDeclaration);if(!t.setIdentifier(this._parseMixinDeclarationIdentifier())||!this.accept(a.TokenType.ParenthesisL))return this.restoreAtMark(e),null;if(t.getParameters().addChild(this._parseMixinParameter()))for(;(this.accept(a.TokenType.Comma)||this.accept(a.TokenType.SemiColon))&&!this.peek(a.TokenType.ParenthesisR);)t.getParameters().addChild(this._parseMixinParameter())||this.markError(t,p.ParseError.IdentifierExpected,[],[a.TokenType.ParenthesisR]);return this.accept(a.TokenType.ParenthesisR)?(t.setGuard(this._parseGuard()),this.peek(a.TokenType.CurlyL)?this._parseBody(t,this._parseMixInBodyDeclaration.bind(this)):(this.restoreAtMark(e),null)):(this.restoreAtMark(e),null)},e.prototype._parseMixInBodyDeclaration=function(){return this._parseFontFace()||this._parseRuleSetDeclaration()},e.prototype._parseMixinDeclarationIdentifier=function(){var e;if(this.peekDelim("#")||this.peekDelim(".")){if(e=this.create(o.Identifier),this.consumeToken(),this.hasWhitespace()||!e.addChild(this._parseIdent()))return null}else{if(!this.peek(a.TokenType.Hash))return null;e=this.create(o.Identifier),this.consumeToken()}return e.referenceTypes=[o.ReferenceType.Mixin],this.finish(e)},e.prototype._parsePseudo=function(){if(!this.peek(a.TokenType.Colon))return null;var e=this.mark(),t=this.create(o.ExtendsReference);return this.consumeToken(),this.acceptIdent("extend")?this._completeExtends(t):(this.restoreAtMark(e),i.prototype._parsePseudo.call(this))},e.prototype._parseExtend=function(){if(!this.peekDelim("&"))return null;var e=this.mark(),t=this.create(o.ExtendsReference);return this.consumeToken(),!this.hasWhitespace()&&this.accept(a.TokenType.Colon)&&this.acceptIdent("extend")?this._completeExtends(t):(this.restoreAtMark(e),null)},e.prototype._completeExtends=function(e){if(!this.accept(a.TokenType.ParenthesisL))return this.finish(e,p.ParseError.LeftParenthesisExpected);var t=e.getSelectors();if(!t.addChild(this._parseSelector(!0)))return this.finish(e,p.ParseError.SelectorExpected);for(;this.accept(a.TokenType.Comma);)if(!t.addChild(this._parseSelector(!0)))return this.finish(e,p.ParseError.SelectorExpected);return this.accept(a.TokenType.ParenthesisR)?this.finish(e):this.finish(e,p.ParseError.RightParenthesisExpected)},e.prototype._parseDetachedRuleSetMixin=function(){if(!this.peek(a.TokenType.AtKeyword))return null;var e=this.mark(),t=this.create(o.MixinReference);return t.addChild(this._parseVariable())&&this.accept(a.TokenType.ParenthesisL)?this.accept(a.TokenType.ParenthesisR)?this.finish(t):this.finish(t,p.ParseError.RightParenthesisExpected):(this.restoreAtMark(e),null)},e.prototype._tryParseMixinReference=function(e){void 0===e&&(e=!1);for(var t=this.mark(),r=this.create(o.MixinReference),i=this._parseMixinDeclarationIdentifier();i;){this.acceptDelim(">");var s=this._parseMixinDeclarationIdentifier();if(!s)break;r.getNamespaces().addChild(i),i=s}if(!r.setIdentifier(i))return this.restoreAtMark(t),null;var n=!1;if(!this.hasWhitespace()&&this.accept(a.TokenType.ParenthesisL)){if(n=!0,r.getArguments().addChild(this._parseMixinArgument()))for(;(this.accept(a.TokenType.Comma)||this.accept(a.TokenType.SemiColon))&&!this.peek(a.TokenType.ParenthesisR);)if(!r.getArguments().addChild(this._parseMixinArgument()))return this.finish(r,p.ParseError.ExpressionExpected);if(!this.accept(a.TokenType.ParenthesisR))return this.finish(r,p.ParseError.RightParenthesisExpected);i.referenceTypes=[o.ReferenceType.Mixin]}else i.referenceTypes=[o.ReferenceType.Mixin,o.ReferenceType.Rule];return r.addChild(this._parsePrio()),n||this.peek(a.TokenType.SemiColon)||this.peek(a.TokenType.CurlyR)||this.peek(a.TokenType.EOF)?this.finish(r):(this.restoreAtMark(t),null)},e.prototype._parseMixinArgument=function(){var e=this.create(o.FunctionArgument),t=this.mark(),r=this._parseVariable();return r&&(this.accept(a.TokenType.Colon)?e.setIdentifier(r):this.restoreAtMark(t)),e.setValue(this._parseDetachedRuleSet()||this._parseExpr(!0))?this.finish(e):(this.restoreAtMark(t),null)},e.prototype._parseMixinParameter=function(){var e=this.create(o.FunctionParameter);if(this.peekKeyword("@rest")){var t=this.create(o.Node);return this.consumeToken(),this.accept(s.Ellipsis)?(e.setIdentifier(this.finish(t)),this.finish(e)):this.finish(e,p.ParseError.DotExpected,[],[a.TokenType.Comma,a.TokenType.ParenthesisR])}if(this.peek(s.Ellipsis)){var r=this.create(o.Node);return this.consumeToken(),e.setIdentifier(this.finish(r)),this.finish(e)}var i=!1;return e.setIdentifier(this._parseVariable())&&(this.accept(a.TokenType.Colon),i=!0),e.setDefaultValue(this._parseExpr(!0))||i?this.finish(e):null},e.prototype._parseGuard=function(){if(!this.peekIdent("when"))return null;var e=this.create(o.LessGuard);if(this.consumeToken(),e.isNegated=this.acceptIdent("not"),!e.getConditions().addChild(this._parseGuardCondition()))return this.finish(e,p.ParseError.ConditionExpected);for(;this.acceptIdent("and")||this.accept(a.TokenType.Comma);)if(!e.getConditions().addChild(this._parseGuardCondition()))return this.finish(e,p.ParseError.ConditionExpected);return this.finish(e)},e.prototype._parseGuardCondition=function(){if(!this.peek(a.TokenType.ParenthesisL))return null;var e=this.create(o.GuardCondition);return this.consumeToken(),e.addChild(this._parseExpr()),this.accept(a.TokenType.ParenthesisR)?this.finish(e):this.finish(e,p.ParseError.RightParenthesisExpected)},e.prototype._parseFunctionIdentifier=function(){if(this.peekDelim("%")){var e=this.create(o.Identifier);return e.referenceTypes=[o.ReferenceType.Function],this.consumeToken(),this.finish(e)}return i.prototype._parseFunctionIdentifier.call(this)},e.prototype._parseURLArgument=function(){var e=this.mark(),t=i.prototype._parseURLArgument.call(this);if(t&&this.peek(a.TokenType.ParenthesisR))return t;this.restoreAtMark(e);var r=this.create(o.Node);return r.addChild(this._parseBinaryExpr()),this.finish(r)},e}(r.Parser);t.LESSParser=i});