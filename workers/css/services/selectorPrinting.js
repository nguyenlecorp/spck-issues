var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","../parser/cssNodes","../parser/cssScanner"],e)}(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d=e("../parser/cssNodes"),n=e("../parser/cssScanner"),p=function(){function a(){}return a.prototype.findAttribute=function(e){if(this.attributes)for(var t=0,r=this.attributes;t<r.length;t++){var n=r[t];if(n.name===e)return n.value}return null},a.prototype.addChild=function(e){e instanceof a&&(e.parent=this),this.children||(this.children=[]),this.children.push(e)},a.prototype.append=function(e){if(this.attributes){var t=this.attributes[this.attributes.length-1];t.value=t.value+e}},a.prototype.prepend=function(e){if(this.attributes){var t=this.attributes[0];t.value=e+t.value}},a.prototype.findRoot=function(){for(var e=this;e.parent&&!(e.parent instanceof c);)e=e.parent;return e},a.prototype.removeChild=function(e){if(this.children){var t=this.children.indexOf(e);if(-1!==t)return this.children.splice(t,1),!0}return!1},a.prototype.addAttr=function(e,t){this.attributes||(this.attributes=[]);for(var r=0,n=this.attributes;r<n.length;r++){var i=n[r];if(i.name===e)return void(i.value+=" "+t)}this.attributes.push({name:e,value:t})},a.prototype.clone=function(e){void 0===e&&(e=!0);var t=new a;if(this.attributes){t.attributes=[];for(var r=0,n=this.attributes;r<n.length;r++){var i=n[r];t.addAttr(i.name,i.value)}}if(e&&this.children){t.children=[];for(var o=0;o<this.children.length;o++)t.addChild(this.children[o].clone())}return t},a.prototype.cloneWithParent=function(){var e=this.clone(!1);!this.parent||this.parent instanceof c||this.parent.cloneWithParent().addChild(e);return e},a}(),c=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(t.Element=p);t.RootElement=c;var h=function(r){function e(e){var t=r.call(this)||this;return t.addAttr("name",e),t}return __extends(e,r),e}(p);t.LabelElement=h;var f,r=function(){function e(e){this.quote=e}return e.prototype.print=function(e){return this.result=[],e instanceof c?this.doPrint(e.children,0):this.doPrint([e],0),[{language:"html",value:this.result.join("\n")}]},e.prototype.doPrint=function(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];this.doPrintElement(i,t),i.children&&this.doPrint(i.children,t+1)}},e.prototype.writeLine=function(e,t){var r=new Array(e+1).join("  ");this.result.push(r+t)},e.prototype.doPrintElement=function(e,t){var r=e.findAttribute("name");if(e instanceof h||"…"===r)this.writeLine(t,r);else{var n=["<"];if(r?n.push(r):n.push("element"),e.attributes)for(var i=0,o=e.attributes;i<o.length;i++){var a=o[i];if("name"!==a.name){n.push(" "),n.push(a.name);var s=a.value;s&&(n.push("="),n.push(f.ensure(s,this.quote)))}}n.push(">"),this.writeLine(t,n.join(""))}},e}();function u(e,t){for(var r=new p,n=0,i=e.getChildren();n<i.length;n++){var o=i[n];switch(o.type){case d.NodeType.SelectorCombinator:if(t){var a=o.getText().split("&");if(1===a.length){r.addAttr("name",a[0]);break}if(r=t.cloneWithParent(),a[0])r.findRoot().prepend(a[0]);for(var s=1;s<a.length;s++){if(1<s){var l=t.cloneWithParent();r.addChild(l.findRoot()),r=l}r.append(a[s])}}break;case d.NodeType.SelectorPlaceholder:if("@at-root"===o.getText())return r;case d.NodeType.ElementNameSelector:var c=o.getText();r.addAttr("name","*"===c?"element":v(c));break;case d.NodeType.ClassSelector:r.addAttr("class",v(o.getText().substring(1)));break;case d.NodeType.IdentifierSelector:r.addAttr("id",v(o.getText().substring(1)));break;case d.NodeType.MixinDeclaration:r.addAttr("class",o.getName());break;case d.NodeType.PseudoSelector:r.addAttr(v(o.getText()),"");break;case d.NodeType.AttributeSelector:var h=o.getExpression();if(h){var u=void 0;if(h.getRight())switch(v(h.getOperator().getText())){case"|=":u=f.remove(v(h.getRight().getText()))+"-…";break;case"^=":u=f.remove(v(h.getRight().getText()))+"…";break;case"$=":u="…"+f.remove(v(h.getRight().getText()));break;case"~=":u=" … "+f.remove(v(h.getRight().getText()))+" … ";break;case"*=":u="…"+f.remove(v(h.getRight().getText()))+"…";break;default:u=f.remove(v(h.getRight().getText()))}r.addAttr(v(h.getLeft().getText()),u)}}}return r}function v(e){var t=new n.Scanner;t.setSource(e);var r=t.scanUnquotedString();return r?r.text:e}!function(e){function r(e){var t=e.match(/^['"](.*)["']$/);return t?t[1]:e}e.ensure=function(e,t){return t+r(e)+t},e.remove=r}(f||(f={})),t.toElement=u,t.selectorToMarkedString=function(e){var t=i(e);return new r('"').print(t)},t.simpleSelectorToMarkedString=function(e){var t=u(e);return new r('"').print(t)};var s=function(){function e(e){this.prev=null,this.element=e}return e.prototype.processSelector=function(e){var t=null;if(!(this.element instanceof c)&&e.getChildren().some(function(e){return e.hasChildren()&&e.getChild(0).type===d.NodeType.SelectorCombinator})){var r=this.element.findRoot();r.parent instanceof c&&(t=this.element,this.element=r.parent,this.element.removeChild(r),this.prev=null)}for(var n=0,i=e.getChildren();n<i.length;n++){var o=i[n];if(o instanceof d.SimpleSelector){if(this.prev instanceof d.SimpleSelector){var a=new h("…");this.element.addChild(a),this.element=a}else this.prev&&(this.prev.matches("+")||this.prev.matches("~"))&&(this.element=this.element.parent);this.prev&&this.prev.matches("~")&&(this.element.addChild(u(o)),this.element.addChild(new h("⋮")));var s=u(o,t),l=s.findRoot();this.element.addChild(l),this.element=s}(o instanceof d.SimpleSelector||o.type===d.NodeType.SelectorCombinatorParent||o.type===d.NodeType.SelectorCombinatorShadowPiercingDescendant||o.type===d.NodeType.SelectorCombinatorSibling||o.type===d.NodeType.SelectorCombinatorAllSiblings)&&(this.prev=o)}},e}();function l(e){switch(e.type){case d.NodeType.MixinDeclaration:case d.NodeType.Stylesheet:return!0}return!1}function i(e){if(e.matches("@at-root"))return null;var t=new c,r=[];if(e.getParent()instanceof d.RuleSet)for(var n=e.getParent().getParent();n&&!l(n);){if(n instanceof d.RuleSet){if(n.getSelectors().matches("@at-root"))break;r.push(n)}n=n.getParent()}for(var i=new s(t),o=r.length-1;0<=o;o--){var a=r[o].getSelectors().getChild(0);a&&i.processSelector(a)}return i.processSelector(e),t}t.selectorToElement=i});