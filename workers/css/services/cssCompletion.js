!function(t){if("object"==typeof module&&"object"==typeof module.exports){var e=t(require,exports);void 0!==e&&(module.exports=e)}else"function"==typeof define&&define.amd&&define(["require","exports","../parser/cssNodes","../parser/cssSymbolScope","./languageFacts","../utils/strings","vscode-languageserver-types","vscode-nls"],t)}(function(t,e){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function o(t){return t.replace(/\(\)$/,"($1)")}function n(t,e){function o(t){return(t instanceof s.Identifier||t instanceof s.NumericValue||t instanceof s.HexColorValue)&&a.add(t.getText()),!0}function n(t){var e=t.getFullPropertyName();return r===e}function i(t){if(t instanceof s.Declaration&&t!==e&&n(t)){var i=t.getValue();i&&i.accept(o)}return!0}var r=e.getFullPropertyName(),a=new h;return t.accept(i),a}function i(t){return void 0!==t}function r(t,e){for(var o=e-1,n=t.getText();o>=0&&-1===' \t\n\r":{[()]},*>+'.indexOf(n.charAt(o));)o--;return n.substring(o+1,e)}Object.defineProperty(e,"__esModule",{value:!0});var s=t("../parser/cssNodes"),a=t("../parser/cssSymbolScope"),l=t("./languageFacts"),p=t("../utils/strings"),u=t("vscode-languageserver-types"),c=t("vscode-nls"),f=c.loadMessageBundle(),m=u.InsertTextFormat.Snippet,d=function(){function t(t){void 0===t&&(t=null),this.completionParticipants=[],this.valueTypes=[s.NodeType.Identifier,s.NodeType.Value,s.NodeType.StringLiteral,s.NodeType.URILiteral,s.NodeType.NumericValue,s.NodeType.HexColorValue,s.NodeType.VariableName,s.NodeType.Prio],this.variablePrefix=t}return t.prototype.getSymbolContext=function(){return this.symbolContext||(this.symbolContext=new a.Symbols(this.styleSheet)),this.symbolContext},t.prototype.setCompletionParticipants=function(t){this.completionParticipants=t||[]},t.prototype.doComplete=function(t,e,o){this.offset=t.offsetAt(e),this.position=e,this.currentWord=r(t,this.offset),this.defaultReplaceRange=u.Range.create(u.Position.create(this.position.line,this.position.character-this.currentWord.length),this.position),this.textDocument=t,this.styleSheet=o;try{var n={isIncomplete:!1,items:[]};this.nodePath=s.getNodePath(this.styleSheet,this.offset);for(var i=this.nodePath.length-1;i>=0;i--){var a=this.nodePath[i];if(a instanceof s.Property)this.getCompletionsForDeclarationProperty(a.getParent(),n);else if(a instanceof s.Expression)this.getCompletionsForExpression(a,n);else if(a instanceof s.SimpleSelector){var l=a.findParent(s.NodeType.Ruleset);this.getCompletionsForSelector(l,l.isNested(),n)}else a instanceof s.FunctionArgument?this.getCompletionsForFunctionArgument(a,a.getParent(),n):a instanceof s.Declarations?this.getCompletionsForDeclarations(a,n):a instanceof s.VariableDeclaration?this.getCompletionsForVariableDeclaration(a,n):a instanceof s.RuleSet?this.getCompletionsForRuleSet(a,n):a instanceof s.Interpolation?this.getCompletionsForInterpolation(a,n):a instanceof s.FunctionDeclaration?this.getCompletionsForFunctionDeclaration(a,n):a instanceof s.MixinReference?this.getCompletionsForMixinReference(a,n):a instanceof s.Function?this.getCompletionsForFunctionArgument(null,a,n):a instanceof s.Supports?this.getCompletionsForSupports(a,n):a instanceof s.SupportsCondition&&this.getCompletionsForSupportsCondition(a,n);if(n.items.length>0)return this.finalize(n)}return this.getCompletionsForStylesheet(n),0===n.items.length&&this.variablePrefix&&0===this.currentWord.indexOf(this.variablePrefix)&&this.getVariableProposals(null,n),this.finalize(n)}finally{this.position=null,this.currentWord=null,this.textDocument=null,this.styleSheet=null,this.symbolContext=null,this.defaultReplaceRange=null,this.nodePath=null}},t.prototype.finalize=function(t){if(t.items.some(function(t){return!!t.sortText}))for(var e=0,o=t.items;e<o.length;e++){var n=o[e];n.sortText||(n.sortText="d")}return t},t.prototype.findInNodePath=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=this.nodePath.length-1;o>=0;o--){var n=this.nodePath[o];if(-1!==t.indexOf(n.type))return n}return null},t.prototype.getCompletionsForDeclarationProperty=function(t,e){return this.getPropertyProposals(t,e)},t.prototype.getPropertyProposals=function(t,e){var o=this,n=l.getProperties();for(var r in n)if(n.hasOwnProperty(r)){var s=n[r];if(s.browsers.onCodeComplete){var a=void 0,c=void 0;t?(a=this.getCompletionRange(t.getProperty()),c=s.name+(i(t.colonPosition)?"":": ")):(a=this.getCompletionRange(null),c=s.name+": ");var f={label:s.name,documentation:l.getEntryDescription(s),textEdit:u.TextEdit.replace(a,c),kind:u.CompletionItemKind.Property,command:{title:"Suggest",command:"editor.action.triggerSuggest"}};p.startsWith(s.name,"-")&&(f.sortText="x"),e.items.push(f)}}return this.completionParticipants.forEach(function(t){t.onCssProperty({propertyName:o.currentWord,range:o.defaultReplaceRange})}),e},t.prototype.getCompletionsForDeclarationValue=function(t,e){for(var o=this,i=t.getFullPropertyName(),r=l.getProperties()[i],s=t.getValue();s&&s.hasChildren();)s=s.findChildAtOffset(this.offset,!1);if(this.completionParticipants.forEach(function(t){t.onCssPropertyValue({propertyName:i,propertyValue:o.currentWord,range:o.getCompletionRange(s)})}),r){for(var a=0,p=r.restrictions;a<p.length;a++){switch(p[a]){case"color":this.getColorProposals(r,s,e);break;case"position":this.getPositionProposals(r,s,e);break;case"repeat":this.getRepeatStyleProposals(r,s,e);break;case"line-style":this.getLineStyleProposals(r,s,e);break;case"line-width":this.getLineWidthProposals(r,s,e);break;case"geometry-box":this.getGeometryBoxProposals(r,s,e);break;case"box":this.getBoxProposals(r,s,e);break;case"image":this.getImageProposals(r,s,e);break;case"timing-function":this.getTimingFunctionProposals(r,s,e);break;case"shape":this.getBasicShapeProposals(r,s,e)}}this.getValueEnumProposals(r,s,e),this.getCSSWideKeywordProposals(r,s,e),this.getUnitProposals(r,s,e)}else for(var c=n(this.styleSheet,t),f=0,m=c.getEntries();f<m.length;f++){var d=m[f];e.items.push({label:d,textEdit:u.TextEdit.replace(this.getCompletionRange(s),d),kind:u.CompletionItemKind.Value})}return this.getVariableProposals(s,e),this.getTermProposals(r,s,e),e},t.prototype.getValueEnumProposals=function(t,e,o){if(t.values)for(var n=0,i=t.values;n<i.length;n++){var r=i[n];if(l.isCommonValue(r)){var s=r.name,a=void 0;if(p.endsWith(s,")")){var c=s.lastIndexOf("(");-1!==c&&(s=s.substr(0,c)+"($1)",a=m)}var f={label:r.name,documentation:l.getEntryDescription(r),textEdit:u.TextEdit.replace(this.getCompletionRange(e),s),kind:u.CompletionItemKind.Value,insertTextFormat:a};o.items.push(f)}}return o},t.prototype.getCSSWideKeywordProposals=function(t,e,o){for(var n in l.cssWideKeywords)o.items.push({label:n,documentation:l.cssWideKeywords[n],textEdit:u.TextEdit.replace(this.getCompletionRange(e),n),kind:u.CompletionItemKind.Value});return o},t.prototype.getCompletionsForInterpolation=function(t,e){return this.offset>=t.offset+2&&this.getVariableProposals(null,e),e},t.prototype.getVariableProposals=function(t,e){for(var o=this.getSymbolContext().findSymbolsAtOffset(this.offset,s.ReferenceType.Variable),n=0,i=o;n<i.length;n++){var r=i[n],a=p.startsWith(r.name,"--")?"var("+r.name+")":r.name,l={label:r.name,documentation:r.value?p.getLimitedString(r.value):r.value,textEdit:u.TextEdit.replace(this.getCompletionRange(t),a),kind:u.CompletionItemKind.Variable,sortText:"z"};if(r.node.type===s.NodeType.FunctionParameter){var c=r.node.getParent();c.type===s.NodeType.MixinDeclaration&&(l.detail=f("completion.argument","argument from '{0}'",c.getName()))}e.items.push(l)}return e},t.prototype.getVariableProposalsForCSSVarFunction=function(t){var e=this.getSymbolContext().findSymbolsAtOffset(this.offset,s.ReferenceType.Variable);e=e.filter(function(t){return p.startsWith(t.name,"--")});for(var o=0,n=e;o<n.length;o++){var i=n[o];t.items.push({label:i.name,documentation:i.value?p.getLimitedString(i.value):i.value,textEdit:u.TextEdit.replace(this.getCompletionRange(null),i.name),kind:u.CompletionItemKind.Variable})}return t},t.prototype.getUnitProposals=function(t,e,o){var n="0";if(this.currentWord.length>0){var i=this.currentWord.match(/^-?\d[\.\d+]*/);i&&(n=i[0],o.isIncomplete=n.length===this.currentWord.length)}else 0===this.currentWord.length&&(o.isIncomplete=!0);e&&e.parent&&e.parent.type===s.NodeType.Term&&(e=e.getParent());for(var r=0,a=t.restrictions;r<a.length;r++){var p=a[r],c=l.units[p];if(c)for(var f=0,m=c;f<m.length;f++){var d=m[f],h=n+d;o.items.push({label:h,textEdit:u.TextEdit.replace(this.getCompletionRange(e),h),kind:u.CompletionItemKind.Unit})}}return o},t.prototype.getCompletionRange=function(t){if(t&&t.offset<=this.offset){var e=-1!==t.end?this.textDocument.positionAt(t.end):this.position;return u.Range.create(this.textDocument.positionAt(t.offset),e)}return this.defaultReplaceRange},t.prototype.getColorProposals=function(t,e,o){for(var n in l.colors)o.items.push({label:n,documentation:l.colors[n],textEdit:u.TextEdit.replace(this.getCompletionRange(e),n),kind:u.CompletionItemKind.Color});for(var n in l.colorKeywords)o.items.push({label:n,documentation:l.colorKeywords[n],textEdit:u.TextEdit.replace(this.getCompletionRange(e),n),kind:u.CompletionItemKind.Value});var i=new h;this.styleSheet.acceptVisitor(new g(i));for(var r=0,s=i.getEntries();r<s.length;r++){var n=s[r];o.items.push({label:n,textEdit:u.TextEdit.replace(this.getCompletionRange(e),n),kind:u.CompletionItemKind.Color})}for(var a=this,p=0,c=l.colorFunctions;p<c.length;p++){var f=c[p];!function(t){var n=1,i=function(t,e){return"${"+n+++":"+e+"}"},r=t.func.replace(/\[?\$(\w+)\]?/g,i);o.items.push({label:t.func.substr(0,t.func.indexOf("(")),detail:t.func,documentation:t.desc,textEdit:u.TextEdit.replace(a.getCompletionRange(e),r),insertTextFormat:m,kind:u.CompletionItemKind.Function})}(f)}return o},t.prototype.getPositionProposals=function(t,e,o){for(var n in l.positionKeywords)o.items.push({label:n,documentation:l.positionKeywords[n],textEdit:u.TextEdit.replace(this.getCompletionRange(e),n),kind:u.CompletionItemKind.Value});return o},t.prototype.getRepeatStyleProposals=function(t,e,o){for(var n in l.repeatStyleKeywords)o.items.push({label:n,documentation:l.repeatStyleKeywords[n],textEdit:u.TextEdit.replace(this.getCompletionRange(e),n),kind:u.CompletionItemKind.Value});return o},t.prototype.getLineStyleProposals=function(t,e,o){for(var n in l.lineStyleKeywords)o.items.push({label:n,documentation:l.lineStyleKeywords[n],textEdit:u.TextEdit.replace(this.getCompletionRange(e),n),kind:u.CompletionItemKind.Value});return o},t.prototype.getLineWidthProposals=function(t,e,o){for(var n=0,i=l.lineWidthKeywords;n<i.length;n++){var r=i[n];o.items.push({label:r,textEdit:u.TextEdit.replace(this.getCompletionRange(e),r),kind:u.CompletionItemKind.Value})}return o},t.prototype.getGeometryBoxProposals=function(t,e,o){for(var n in l.geometryBoxKeywords)o.items.push({label:n,documentation:l.geometryBoxKeywords[n],textEdit:u.TextEdit.replace(this.getCompletionRange(e),n),kind:u.CompletionItemKind.Value});return o},t.prototype.getBoxProposals=function(t,e,o){for(var n in l.boxKeywords)o.items.push({label:n,documentation:l.boxKeywords[n],textEdit:u.TextEdit.replace(this.getCompletionRange(e),n),kind:u.CompletionItemKind.Value});return o},t.prototype.getImageProposals=function(t,e,n){for(var i in l.imageFunctions){var r=o(i);n.items.push({label:i,documentation:l.imageFunctions[i],textEdit:u.TextEdit.replace(this.getCompletionRange(e),r),kind:u.CompletionItemKind.Function,insertTextFormat:i!==r?m:void 0})}return n},t.prototype.getTimingFunctionProposals=function(t,e,n){for(var i in l.transitionTimingFunctions){var r=o(i);n.items.push({label:i,documentation:l.transitionTimingFunctions[i],textEdit:u.TextEdit.replace(this.getCompletionRange(e),r),kind:u.CompletionItemKind.Function,insertTextFormat:i!==r?m:void 0})}return n},t.prototype.getBasicShapeProposals=function(t,e,n){for(var i in l.basicShapeFunctions){var r=o(i);n.items.push({label:i,documentation:l.basicShapeFunctions[i],textEdit:u.TextEdit.replace(this.getCompletionRange(e),r),kind:u.CompletionItemKind.Function,insertTextFormat:i!==r?m:void 0})}return n},t.prototype.getCompletionsForStylesheet=function(t){var e=this.styleSheet.findFirstChildBeforeOffset(this.offset);return e?e instanceof s.RuleSet?this.getCompletionsForRuleSet(e,t):e instanceof s.Supports?this.getCompletionsForSupports(e,t):t:this.getCompletionForTopLevel(t)},t.prototype.getCompletionForTopLevel=function(t){for(var e=0,o=l.getAtDirectives();e<o.length;e++){var n=o[e];n.browsers.count>0&&t.items.push({label:n.name,textEdit:u.TextEdit.replace(this.getCompletionRange(null),n.name),documentation:l.getEntryDescription(n),kind:u.CompletionItemKind.Keyword})}return this.getCompletionsForSelector(null,!1,t),t},t.prototype.getCompletionsForRuleSet=function(t,e){var o=t.getDeclarations();return o&&o.endsWith("}")&&this.offset>=o.end?this.getCompletionForTopLevel(e):!o||this.offset<=o.offset?this.getCompletionsForSelector(t,t.isNested(),e):(t.findParent(s.NodeType.Ruleset),this.getCompletionsForDeclarations(t.getDeclarations(),e))},t.prototype.getCompletionsForSelector=function(t,e,n){var i=this,r=this.findInNodePath(s.NodeType.PseudoSelector,s.NodeType.IdentifierSelector,s.NodeType.ClassSelector,s.NodeType.ElementNameSelector);!r&&this.offset-this.currentWord.length>0&&":"===this.textDocument.getText()[this.offset-this.currentWord.length-1]&&(this.currentWord=":"+this.currentWord,this.defaultReplaceRange=u.Range.create(u.Position.create(this.position.line,this.position.character-this.currentWord.length),this.position));for(var a=0,c=l.getPseudoClasses();a<c.length;a++){var f=c[a];if(f.browsers.onCodeComplete){var d=o(f.name),h={label:f.name,textEdit:u.TextEdit.replace(this.getCompletionRange(r),d),documentation:l.getEntryDescription(f),kind:u.CompletionItemKind.Function,insertTextFormat:f.name!==d?m:void 0};p.startsWith(f.name,":-")&&(h.sortText="x"),n.items.push(h)}}for(var g=0,y=l.getPseudoElements();g<y.length;g++){var f=y[g];if(f.browsers.onCodeComplete){var d=o(f.name),h={label:f.name,textEdit:u.TextEdit.replace(this.getCompletionRange(r),d),documentation:l.getEntryDescription(f),kind:u.CompletionItemKind.Function,insertTextFormat:f.name!==d?m:void 0};p.startsWith(f.name,"::-")&&(h.sortText="x"),n.items.push(h)}}if(!e){for(var C=0,v=l.html5Tags;C<v.length;C++){var f=v[C];n.items.push({label:f,textEdit:u.TextEdit.replace(this.getCompletionRange(r),f),kind:u.CompletionItemKind.Keyword})}for(var x=0,P=l.svgElements;x<P.length;x++){var f=P[x];n.items.push({label:f,textEdit:u.TextEdit.replace(this.getCompletionRange(r),f),kind:u.CompletionItemKind.Keyword})}}var F={};F[this.currentWord]=!0;var T=this.styleSheet.getTextProvider();if(this.styleSheet.accept(function(t){if(t.type===s.NodeType.SimpleSelector&&t.length>0){var e=T(t.offset,t.length);return"."!==e.charAt(0)||F[e]||(F[e]=!0,n.items.push({label:e,textEdit:u.TextEdit.replace(i.getCompletionRange(r),e),kind:u.CompletionItemKind.Keyword})),!1}return!0}),t&&t.isNested()){var b=t.getSelectors().findFirstChildBeforeOffset(this.offset);b&&0===t.getSelectors().getChildren().indexOf(b)&&this.getPropertyProposals(null,n)}return n},t.prototype.getCompletionsForDeclarations=function(t,e){if(!t||this.offset===t.offset)return e;var o=t.findFirstChildBeforeOffset(this.offset);if(!o)return this.getCompletionsForDeclarationProperty(null,e);if(o instanceof s.AbstractDeclaration){var n=o;if(!i(n.colonPosition||this.offset<=n.colonPosition))return this.getCompletionsForDeclarationProperty(n,e);if(i(n.semicolonPosition)&&n.semicolonPosition<this.offset)return this.offset===n.semicolonPosition+1?e:this.getCompletionsForDeclarationProperty(null,e);if(n instanceof s.Declaration)return this.getCompletionsForDeclarationValue(n,e)}return e},t.prototype.getCompletionsForVariableDeclaration=function(t,e){return this.offset>t.colonPosition&&this.getVariableProposals(t.getValue(),e),e},t.prototype.getCompletionsForExpression=function(t,e){if(t.getParent()instanceof s.FunctionArgument)return this.getCompletionsForFunctionArgument(t.getParent(),t.getParent().getParent(),e),e;var o=t.findParent(s.NodeType.Declaration);if(!o)return this.getTermProposals(null,null,e),e;var n=t.findChildAtOffset(this.offset,!0);return n?n instanceof s.NumericValue||n instanceof s.Identifier?this.getCompletionsForDeclarationValue(o,e):e:this.getCompletionsForDeclarationValue(o,e)},t.prototype.getCompletionsForFunctionArgument=function(t,e,o){return"var"===e.getIdentifier().getText()&&(e.getArguments().hasChildren()&&e.getArguments().getChild(0)!==t||this.getVariableProposalsForCSSVarFunction(o)),o},t.prototype.getCompletionsForFunctionDeclaration=function(t,e){var o=t.getDeclarations();return o&&this.offset>o.offset&&this.offset<o.end&&this.getTermProposals(null,null,e),e},t.prototype.getCompletionsForMixinReference=function(t,e){for(var o=this.getSymbolContext().findSymbolsAtOffset(this.offset,s.ReferenceType.Mixin),n=0,i=o;n<i.length;n++){var r=i[n];r.node instanceof s.MixinDeclaration&&e.items.push(this.makeTermProposal(r,r.node.getParameters(),null))}return e},t.prototype.getTermProposals=function(t,e,o){for(var n=this.getSymbolContext().findSymbolsAtOffset(this.offset,s.ReferenceType.Function),i=0,r=n;i<r.length;i++){var a=r[i];a.node instanceof s.FunctionDeclaration&&o.items.push(this.makeTermProposal(a,a.node.getParameters(),e))}return o},t.prototype.makeTermProposal=function(t,e,o){var n=(t.node,e.getChildren().map(function(t){return t instanceof s.FunctionParameter?t.getName():t.getText()})),i=t.name+"("+n.map(function(t,e){return"${"+(e+1)+":"+t+"}"}).join(", ")+")";return{label:t.name,detail:t.name+"("+n.join(", ")+")",textEdit:u.TextEdit.replace(this.getCompletionRange(o),i),insertTextFormat:m,kind:u.CompletionItemKind.Function,sortText:"z"}},t.prototype.getCompletionsForSupportsCondition=function(t,e){var o=t.findFirstChildBeforeOffset(this.offset);if(o){if(o instanceof s.Declaration)return i(o.colonPosition||this.offset<=o.colonPosition)?this.getCompletionsForDeclarationValue(o,e):this.getCompletionsForDeclarationProperty(o,e);if(o instanceof s.SupportsCondition)return this.getCompletionsForSupportsCondition(o,e)}return i(t.lParent)&&this.offset>t.lParent&&(!i(t.rParent)||this.offset<=t.rParent)?this.getCompletionsForDeclarationProperty(null,e):e},t.prototype.getCompletionsForSupports=function(t,e){var o=t.getDeclarations();if(!o||this.offset<=o.offset){var n=t.findFirstChildBeforeOffset(this.offset);return n instanceof s.SupportsCondition?this.getCompletionsForSupportsCondition(n,e):e}return this.getCompletionForTopLevel(e)},t}();e.CSSCompletion=d;var h=function(){function t(){this.entries={}}return t.prototype.add=function(t){this.entries[t]=!0},t.prototype.getEntries=function(){return Object.keys(this.entries)},t}(),g=function(){function t(t){this.entries=t}return t.prototype.visitNode=function(t){return(t instanceof s.HexColorValue||t instanceof s.Function&&l.isColorConstructor(t))&&this.entries.add(t.getText()),!0},t}()});