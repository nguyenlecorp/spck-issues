!function(t){if("object"==typeof module&&"object"==typeof module.exports){var e=t(require,exports);void 0!==e&&(module.exports=e)}else"function"==typeof define&&define.amd&&define(["require","exports","../parser/cssNodes","../parser/cssSymbolScope","./languageFacts","../utils/strings","vscode-languageserver-types","vscode-nls"],t)}((function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=t("../parser/cssNodes"),i=t("../parser/cssSymbolScope"),n=t("./languageFacts"),r=t("../utils/strings"),s=t("vscode-languageserver-types"),a=t("vscode-nls").loadMessageBundle(),l=s.InsertTextFormat.Snippet,p=function(){function t(t){void 0===t&&(t=null),this.completionParticipants=[],this.valueTypes=[o.NodeType.Identifier,o.NodeType.Value,o.NodeType.StringLiteral,o.NodeType.URILiteral,o.NodeType.NumericValue,o.NodeType.HexColorValue,o.NodeType.VariableName,o.NodeType.Prio],this.variablePrefix=t}return t.prototype.getSymbolContext=function(){return this.symbolContext||(this.symbolContext=new i.Symbols(this.styleSheet)),this.symbolContext},t.prototype.setCompletionParticipants=function(t){this.completionParticipants=t||[]},t.prototype.doComplete=function(t,e,i){this.offset=t.offsetAt(e),this.position=e,this.currentWord=function(t,e){var o=e-1,i=t.getText();for(;o>=0&&-1===' \t\n\r":{[()]},*>+'.indexOf(i.charAt(o));)o--;return i.substring(o+1,e)}(t,this.offset),this.defaultReplaceRange=s.Range.create(s.Position.create(this.position.line,this.position.character-this.currentWord.length),this.position),this.textDocument=t,this.styleSheet=i;try{var n={isIncomplete:!1,items:[]};this.nodePath=o.getNodePath(this.styleSheet,this.offset);for(var r=this.nodePath.length-1;r>=0;r--){var a=this.nodePath[r];if(a instanceof o.Property)this.getCompletionsForDeclarationProperty(a.getParent(),n);else if(a instanceof o.Expression)this.getCompletionsForExpression(a,n);else if(a instanceof o.SimpleSelector){var l=a.findParent(o.NodeType.Ruleset);this.getCompletionsForSelector(l,l.isNested(),n)}else a instanceof o.FunctionArgument?this.getCompletionsForFunctionArgument(a,a.getParent(),n):a instanceof o.Declarations?this.getCompletionsForDeclarations(a,n):a instanceof o.VariableDeclaration?this.getCompletionsForVariableDeclaration(a,n):a instanceof o.RuleSet?this.getCompletionsForRuleSet(a,n):a instanceof o.Interpolation?this.getCompletionsForInterpolation(a,n):a instanceof o.FunctionDeclaration?this.getCompletionsForFunctionDeclaration(a,n):a instanceof o.MixinReference?this.getCompletionsForMixinReference(a,n):a instanceof o.Function?this.getCompletionsForFunctionArgument(null,a,n):a instanceof o.Supports?this.getCompletionsForSupports(a,n):a instanceof o.SupportsCondition&&this.getCompletionsForSupportsCondition(a,n);if(n.items.length>0)return this.finalize(n)}return this.getCompletionsForStylesheet(n),0===n.items.length&&this.variablePrefix&&0===this.currentWord.indexOf(this.variablePrefix)&&this.getVariableProposals(null,n),this.finalize(n)}finally{this.position=null,this.currentWord=null,this.textDocument=null,this.styleSheet=null,this.symbolContext=null,this.defaultReplaceRange=null,this.nodePath=null}},t.prototype.finalize=function(t){if(t.items.some((function(t){return!!t.sortText})))for(var e=0,o=t.items;e<o.length;e++){var i=o[e];i.sortText||(i.sortText="d")}return t},t.prototype.findInNodePath=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var o=this.nodePath.length-1;o>=0;o--){var i=this.nodePath[o];if(-1!==t.indexOf(i.type))return i}return null},t.prototype.getCompletionsForDeclarationProperty=function(t,e){return this.getPropertyProposals(t,e)},t.prototype.getPropertyProposals=function(t,e){var o=this,i=n.getProperties();for(var a in i)if(i.hasOwnProperty(a)){var l=i[a];if(l.browsers.onCodeComplete){var p=void 0,u=void 0;t?(p=this.getCompletionRange(t.getProperty()),u=l.name+(m(t.colonPosition)?"":": ")):(p=this.getCompletionRange(null),u=l.name+": ");var c={label:l.name,documentation:n.getEntryDescription(l),textEdit:s.TextEdit.replace(p,u),kind:s.CompletionItemKind.Property,command:{title:"Suggest",command:"editor.action.triggerSuggest"}};r.startsWith(l.name,"-")&&(c.sortText="x"),e.items.push(c)}}return this.completionParticipants.forEach((function(t){t.onCssProperty({propertyName:o.currentWord,range:o.defaultReplaceRange})})),e},t.prototype.getCompletionsForDeclarationValue=function(t,e){for(var i=this,r=t.getFullPropertyName(),a=n.getProperties()[r],l=t.getValue();l&&l.hasChildren();)l=l.findChildAtOffset(this.offset,!1);if(this.completionParticipants.forEach((function(t){t.onCssPropertyValue({propertyName:r,propertyValue:i.currentWord,range:i.getCompletionRange(l)})})),a){for(var p=0,c=a.restrictions;p<c.length;p++){switch(c[p]){case"color":this.getColorProposals(a,l,e);break;case"position":this.getPositionProposals(a,l,e);break;case"repeat":this.getRepeatStyleProposals(a,l,e);break;case"line-style":this.getLineStyleProposals(a,l,e);break;case"line-width":this.getLineWidthProposals(a,l,e);break;case"geometry-box":this.getGeometryBoxProposals(a,l,e);break;case"box":this.getBoxProposals(a,l,e);break;case"image":this.getImageProposals(a,l,e);break;case"timing-function":this.getTimingFunctionProposals(a,l,e);break;case"shape":this.getBasicShapeProposals(a,l,e)}}this.getValueEnumProposals(a,l,e),this.getCSSWideKeywordProposals(a,l,e),this.getUnitProposals(a,l,e)}else for(var f=0,m=function(t,e){var i=e.getFullPropertyName(),n=new u;function r(t){return(t instanceof o.Identifier||t instanceof o.NumericValue||t instanceof o.HexColorValue)&&n.add(t.getText()),!0}return t.accept((function(t){if(t instanceof o.Declaration&&t!==e&&(s=t.getFullPropertyName(),i===s)){var n=t.getValue();n&&n.accept(r)}var s;return!0})),n}(this.styleSheet,t).getEntries();f<m.length;f++){var d=m[f];e.items.push({label:d,textEdit:s.TextEdit.replace(this.getCompletionRange(l),d),kind:s.CompletionItemKind.Value})}return this.getVariableProposals(l,e),this.getTermProposals(a,l,e),e},t.prototype.getValueEnumProposals=function(t,e,o){if(t.values)for(var i=0,a=t.values;i<a.length;i++){var p=a[i];if(n.isCommonValue(p)){var u=p.name,c=void 0;if(r.endsWith(u,")")){var f=u.lastIndexOf("(");-1!==f&&(u=u.substr(0,f)+"($1)",c=l)}var m={label:p.name,documentation:n.getEntryDescription(p),textEdit:s.TextEdit.replace(this.getCompletionRange(e),u),kind:s.CompletionItemKind.Value,insertTextFormat:c};o.items.push(m)}}return o},t.prototype.getCSSWideKeywordProposals=function(t,e,o){for(var i in n.cssWideKeywords)o.items.push({label:i,documentation:n.cssWideKeywords[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),i),kind:s.CompletionItemKind.Value});return o},t.prototype.getCompletionsForInterpolation=function(t,e){return this.offset>=t.offset+2&&this.getVariableProposals(null,e),e},t.prototype.getVariableProposals=function(t,e){for(var i=0,n=this.getSymbolContext().findSymbolsAtOffset(this.offset,o.ReferenceType.Variable);i<n.length;i++){var l=n[i],p=r.startsWith(l.name,"--")?"var("+l.name+")":l.name,u={label:l.name,documentation:l.value?r.getLimitedString(l.value):l.value,textEdit:s.TextEdit.replace(this.getCompletionRange(t),p),kind:s.CompletionItemKind.Variable,sortText:"z"};if(l.node.type===o.NodeType.FunctionParameter){var c=l.node.getParent();c.type===o.NodeType.MixinDeclaration&&(u.detail=a("completion.argument","argument from '{0}'",c.getName()))}e.items.push(u)}return e},t.prototype.getVariableProposalsForCSSVarFunction=function(t){for(var e=this.getSymbolContext().findSymbolsAtOffset(this.offset,o.ReferenceType.Variable),i=0,n=e=e.filter((function(t){return r.startsWith(t.name,"--")}));i<n.length;i++){var a=n[i];t.items.push({label:a.name,documentation:a.value?r.getLimitedString(a.value):a.value,textEdit:s.TextEdit.replace(this.getCompletionRange(null),a.name),kind:s.CompletionItemKind.Variable})}return t},t.prototype.getUnitProposals=function(t,e,i){var r="0";if(this.currentWord.length>0){var a=this.currentWord.match(/^-?\d[\.\d+]*/);a&&(r=a[0],i.isIncomplete=r.length===this.currentWord.length)}else 0===this.currentWord.length&&(i.isIncomplete=!0);e&&e.parent&&e.parent.type===o.NodeType.Term&&(e=e.getParent());for(var l=0,p=t.restrictions;l<p.length;l++){var u=p[l],c=n.units[u];if(c)for(var f=0,m=c;f<m.length;f++){var d=r+m[f];i.items.push({label:d,textEdit:s.TextEdit.replace(this.getCompletionRange(e),d),kind:s.CompletionItemKind.Unit})}}return i},t.prototype.getCompletionRange=function(t){if(t&&t.offset<=this.offset){var e=-1!==t.end?this.textDocument.positionAt(t.end):this.position;return s.Range.create(this.textDocument.positionAt(t.offset),e)}return this.defaultReplaceRange},t.prototype.getColorProposals=function(t,e,o){for(var i in n.colors)o.items.push({label:i,documentation:n.colors[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),i),kind:s.CompletionItemKind.Color});for(var i in n.colorKeywords)o.items.push({label:i,documentation:n.colorKeywords[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),i),kind:s.CompletionItemKind.Value});var r=new u;this.styleSheet.acceptVisitor(new f(r));for(var a=0,p=r.getEntries();a<p.length;a++){i=p[a];o.items.push({label:i,textEdit:s.TextEdit.replace(this.getCompletionRange(e),i),kind:s.CompletionItemKind.Color})}for(var c=function(t){var i=1,n=t.func.replace(/\[?\$(\w+)\]?/g,(function(t,e){return"${"+i+++":"+e+"}"}));o.items.push({label:t.func.substr(0,t.func.indexOf("(")),detail:t.func,documentation:t.desc,textEdit:s.TextEdit.replace(m.getCompletionRange(e),n),insertTextFormat:l,kind:s.CompletionItemKind.Function})},m=this,d=0,h=n.colorFunctions;d<h.length;d++){c(h[d])}return o},t.prototype.getPositionProposals=function(t,e,o){for(var i in n.positionKeywords)o.items.push({label:i,documentation:n.positionKeywords[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),i),kind:s.CompletionItemKind.Value});return o},t.prototype.getRepeatStyleProposals=function(t,e,o){for(var i in n.repeatStyleKeywords)o.items.push({label:i,documentation:n.repeatStyleKeywords[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),i),kind:s.CompletionItemKind.Value});return o},t.prototype.getLineStyleProposals=function(t,e,o){for(var i in n.lineStyleKeywords)o.items.push({label:i,documentation:n.lineStyleKeywords[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),i),kind:s.CompletionItemKind.Value});return o},t.prototype.getLineWidthProposals=function(t,e,o){for(var i=0,r=n.lineWidthKeywords;i<r.length;i++){var a=r[i];o.items.push({label:a,textEdit:s.TextEdit.replace(this.getCompletionRange(e),a),kind:s.CompletionItemKind.Value})}return o},t.prototype.getGeometryBoxProposals=function(t,e,o){for(var i in n.geometryBoxKeywords)o.items.push({label:i,documentation:n.geometryBoxKeywords[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),i),kind:s.CompletionItemKind.Value});return o},t.prototype.getBoxProposals=function(t,e,o){for(var i in n.boxKeywords)o.items.push({label:i,documentation:n.boxKeywords[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),i),kind:s.CompletionItemKind.Value});return o},t.prototype.getImageProposals=function(t,e,o){for(var i in n.imageFunctions){var r=c(i);o.items.push({label:i,documentation:n.imageFunctions[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),r),kind:s.CompletionItemKind.Function,insertTextFormat:i!==r?l:void 0})}return o},t.prototype.getTimingFunctionProposals=function(t,e,o){for(var i in n.transitionTimingFunctions){var r=c(i);o.items.push({label:i,documentation:n.transitionTimingFunctions[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),r),kind:s.CompletionItemKind.Function,insertTextFormat:i!==r?l:void 0})}return o},t.prototype.getBasicShapeProposals=function(t,e,o){for(var i in n.basicShapeFunctions){var r=c(i);o.items.push({label:i,documentation:n.basicShapeFunctions[i],textEdit:s.TextEdit.replace(this.getCompletionRange(e),r),kind:s.CompletionItemKind.Function,insertTextFormat:i!==r?l:void 0})}return o},t.prototype.getCompletionsForStylesheet=function(t){var e=this.styleSheet.findFirstChildBeforeOffset(this.offset);return e?e instanceof o.RuleSet?this.getCompletionsForRuleSet(e,t):e instanceof o.Supports?this.getCompletionsForSupports(e,t):t:this.getCompletionForTopLevel(t)},t.prototype.getCompletionForTopLevel=function(t){for(var e=0,o=n.getAtDirectives();e<o.length;e++){var i=o[e];i.browsers.count>0&&t.items.push({label:i.name,textEdit:s.TextEdit.replace(this.getCompletionRange(null),i.name),documentation:n.getEntryDescription(i),kind:s.CompletionItemKind.Keyword})}return this.getCompletionsForSelector(null,!1,t),t},t.prototype.getCompletionsForRuleSet=function(t,e){var i=t.getDeclarations();return i&&i.endsWith("}")&&this.offset>=i.end?this.getCompletionForTopLevel(e):!i||this.offset<=i.offset?this.getCompletionsForSelector(t,t.isNested(),e):(t.findParent(o.NodeType.Ruleset),this.getCompletionsForDeclarations(t.getDeclarations(),e))},t.prototype.getCompletionsForSelector=function(t,e,i){var a=this,p=this.findInNodePath(o.NodeType.PseudoSelector,o.NodeType.IdentifierSelector,o.NodeType.ClassSelector,o.NodeType.ElementNameSelector);!p&&this.offset-this.currentWord.length>0&&":"===this.textDocument.getText()[this.offset-this.currentWord.length-1]&&(this.currentWord=":"+this.currentWord,this.defaultReplaceRange=s.Range.create(s.Position.create(this.position.line,this.position.character-this.currentWord.length),this.position));for(var u=0,f=n.getPseudoClasses();u<f.length;u++){if((v=f[u]).browsers.onCodeComplete){var m=c(v.name),d={label:v.name,textEdit:s.TextEdit.replace(this.getCompletionRange(p),m),documentation:n.getEntryDescription(v),kind:s.CompletionItemKind.Function,insertTextFormat:v.name!==m?l:void 0};r.startsWith(v.name,":-")&&(d.sortText="x"),i.items.push(d)}}for(var h=0,g=n.getPseudoElements();h<g.length;h++){if((v=g[h]).browsers.onCodeComplete){m=c(v.name),d={label:v.name,textEdit:s.TextEdit.replace(this.getCompletionRange(p),m),documentation:n.getEntryDescription(v),kind:s.CompletionItemKind.Function,insertTextFormat:v.name!==m?l:void 0};r.startsWith(v.name,"::-")&&(d.sortText="x"),i.items.push(d)}}if(!e){for(var y=0,C=n.html5Tags;y<C.length;y++){var v=C[y];i.items.push({label:v,textEdit:s.TextEdit.replace(this.getCompletionRange(p),v),kind:s.CompletionItemKind.Keyword})}for(var x=0,P=n.svgElements;x<P.length;x++){v=P[x];i.items.push({label:v,textEdit:s.TextEdit.replace(this.getCompletionRange(p),v),kind:s.CompletionItemKind.Keyword})}}var F={};F[this.currentWord]=!0;var T=this.styleSheet.getTextProvider();if(this.styleSheet.accept((function(t){if(t.type===o.NodeType.SimpleSelector&&t.length>0){var e=T(t.offset,t.length);return"."!==e.charAt(0)||F[e]||(F[e]=!0,i.items.push({label:e,textEdit:s.TextEdit.replace(a.getCompletionRange(p),e),kind:s.CompletionItemKind.Keyword})),!1}return!0})),t&&t.isNested()){var b=t.getSelectors().findFirstChildBeforeOffset(this.offset);b&&0===t.getSelectors().getChildren().indexOf(b)&&this.getPropertyProposals(null,i)}return i},t.prototype.getCompletionsForDeclarations=function(t,e){if(!t||this.offset===t.offset)return e;var i=t.findFirstChildBeforeOffset(this.offset);if(!i)return this.getCompletionsForDeclarationProperty(null,e);if(i instanceof o.AbstractDeclaration){var n=i;if(!m(n.colonPosition||this.offset<=n.colonPosition))return this.getCompletionsForDeclarationProperty(n,e);if(m(n.semicolonPosition)&&n.semicolonPosition<this.offset)return this.offset===n.semicolonPosition+1?e:this.getCompletionsForDeclarationProperty(null,e);if(n instanceof o.Declaration)return this.getCompletionsForDeclarationValue(n,e)}return e},t.prototype.getCompletionsForVariableDeclaration=function(t,e){return this.offset>t.colonPosition&&this.getVariableProposals(t.getValue(),e),e},t.prototype.getCompletionsForExpression=function(t,e){if(t.getParent()instanceof o.FunctionArgument)return this.getCompletionsForFunctionArgument(t.getParent(),t.getParent().getParent(),e),e;var i=t.findParent(o.NodeType.Declaration);if(!i)return this.getTermProposals(null,null,e),e;var n=t.findChildAtOffset(this.offset,!0);return n?n instanceof o.NumericValue||n instanceof o.Identifier?this.getCompletionsForDeclarationValue(i,e):e:this.getCompletionsForDeclarationValue(i,e)},t.prototype.getCompletionsForFunctionArgument=function(t,e,o){return"var"===e.getIdentifier().getText()&&(e.getArguments().hasChildren()&&e.getArguments().getChild(0)!==t||this.getVariableProposalsForCSSVarFunction(o)),o},t.prototype.getCompletionsForFunctionDeclaration=function(t,e){var o=t.getDeclarations();return o&&this.offset>o.offset&&this.offset<o.end&&this.getTermProposals(null,null,e),e},t.prototype.getCompletionsForMixinReference=function(t,e){for(var i=0,n=this.getSymbolContext().findSymbolsAtOffset(this.offset,o.ReferenceType.Mixin);i<n.length;i++){var r=n[i];r.node instanceof o.MixinDeclaration&&e.items.push(this.makeTermProposal(r,r.node.getParameters(),null))}return e},t.prototype.getTermProposals=function(t,e,i){for(var n=0,r=this.getSymbolContext().findSymbolsAtOffset(this.offset,o.ReferenceType.Function);n<r.length;n++){var s=r[n];s.node instanceof o.FunctionDeclaration&&i.items.push(this.makeTermProposal(s,s.node.getParameters(),e))}return i},t.prototype.makeTermProposal=function(t,e,i){t.node;var n=e.getChildren().map((function(t){return t instanceof o.FunctionParameter?t.getName():t.getText()})),r=t.name+"("+n.map((function(t,e){return"${"+(e+1)+":"+t+"}"})).join(", ")+")";return{label:t.name,detail:t.name+"("+n.join(", ")+")",textEdit:s.TextEdit.replace(this.getCompletionRange(i),r),insertTextFormat:l,kind:s.CompletionItemKind.Function,sortText:"z"}},t.prototype.getCompletionsForSupportsCondition=function(t,e){var i=t.findFirstChildBeforeOffset(this.offset);if(i){if(i instanceof o.Declaration)return m(i.colonPosition||this.offset<=i.colonPosition)?this.getCompletionsForDeclarationValue(i,e):this.getCompletionsForDeclarationProperty(i,e);if(i instanceof o.SupportsCondition)return this.getCompletionsForSupportsCondition(i,e)}return m(t.lParent)&&this.offset>t.lParent&&(!m(t.rParent)||this.offset<=t.rParent)?this.getCompletionsForDeclarationProperty(null,e):e},t.prototype.getCompletionsForSupports=function(t,e){var i=t.getDeclarations();if(!i||this.offset<=i.offset){var n=t.findFirstChildBeforeOffset(this.offset);return n instanceof o.SupportsCondition?this.getCompletionsForSupportsCondition(n,e):e}return this.getCompletionForTopLevel(e)},t}();e.CSSCompletion=p;var u=function(){function t(){this.entries={}}return t.prototype.add=function(t){this.entries[t]=!0},t.prototype.getEntries=function(){return Object.keys(this.entries)},t}();function c(t){return t.replace(/\(\)$/,"($1)")}var f=function(){function t(t){this.entries=t}return t.prototype.visitNode=function(t){return(t instanceof o.HexColorValue||t instanceof o.Function&&n.isColorConstructor(t))&&this.entries.add(t.getText()),!0},t}();function m(t){return void 0!==t}}));