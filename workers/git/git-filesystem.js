var GitFileSystem=new GitFileSystemClass;function GitFileSystemClass(){var s=ProjectStore,e=this,o={};function n(e){return s.files.get({path:e}).then(function(e){return e&&e.deleted?null:e&&e.target?n(e.target):e})}function i(e){var i=e.split("/").map(function(e,t,r){return r.slice(0,t+1).join("/")});return s.folders.where("path").anyOf(i).keys(function(t){return e=i.filter(function(e){return-1===t.indexOf(e)}),r=Date.now(),n=e.map(function(e){return{id:c(),path:e,mtimeMs:r,ctimeMs:r}}),s.folders.bulkAdd(n);var e,r,n})}function u(l,t,m){return m=m||{},i((e=l,r=e.lastIndexOf("/"),-1===r?".":0===r?"/":e.slice(0,r))).then(function(){var u,f={},a=Buffer.from(t);return n(l).then(function(e){var t,r=(t=a,sha1(Buffer.concat([Buffer.from("blob "+t.buffer.byteLength.toString()+"\0"),t]))),n=Date.now();if(e){var i=e.ctimeMs||n;return f.fid=e.fid,u={id:e.id,fid:e.fid,path:l,deleted:!1,hash:r,remoteHash:r,remotePath:l,mode:m.mode,target:m.target,ctimeMs:i,mtimeMs:n},s.files.update(e.id,{deleted:!1,hash:r,remoteHash:r,remotePath:l,mode:m.mode,target:m.target,ctimeMs:i,mtimeMs:n})}var o=f.fid=c();return u={id:o,fid:o,path:l,hash:r,remoteHash:r,remotePath:l,mode:m.mode,target:m.target,ctimeMs:n,mtimeMs:n},s.files.put(u)}).then(function(){var e;return(e=t)&&e.buffer instanceof ArrayBuffer&&void 0!==e.byteLength?(f.remoteText=f.text=toArrayBuffer(a),f.remoteEncoding=f.encoding="binary"):"string"==typeof t&&(f.remoteText=f.text=t),s.data.put(f)}).then(function(){return GlobalEmitter.emit("::write",{file:u}),{mode:u.mode,type:"file",size:f.text.length,mtimeMs:u.mtimeMs,ino:0}})});var e,r}function r(t){return s.folders.get({path:t}).then(function(e){if(e)return GlobalEmitter.emit("::remove",{folder:e}),s.folders.update(e.id,{deleted:!0}).then(function(){return Promise.all([s.files.where("path").startsWith(t+"/").modify({deleted:!0,ctimeMs:Date.now(),remotePath:null,remoteHash:null}),s.folders.where("path").startsWith(t+"/").modify({deleted:!0})])}).then(function(){return f(t)})})}function f(e){var t=e.slice(0,e.lastIndexOf("/"));return s.files.where("path").startsWith(t+"/").and(function(e){return!e.deleted}).toArray().then(function(e){if(0===e.length)return r(t)})}function t(e,t){return e=m(e)+"/",Promise.resolve(t?s.folders.where("path").startsWith(e).toArray():[]).then(function(r){return s.files.where("path").startsWith(e).toArray().then(function(e){var t=[];return r&&(t=t.concat(r)),e&&(t=t.concat(e)),t.filter(function(e){return!e.deleted}).map(function(e){return e.path})})})}function a(t){return-1===(t=m(t)).indexOf("/")?new Stats(FileType.DIRECTORY,0):s.files.get({path:t}).then(function(e){return e?new Stats(FileType.FILE,1,e.mode,null,e.mtimeMs,e.ctimeMs,null,e.target):s.folders.get({path:t}).then(function(e){return e?new Stats(FileType.DIRECTORY,0,null,null,e.mtimeMs,e.ctimeMs,null,e.target):null})})}function c(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function l(e,t){return-(e<t)||+(t<e)}function m(e){if(0<=e.indexOf("\0"))throw new Error("Path must be a string without null bytes.");if(""===e)throw new Error("Path must not be empty.");return e.split("/").filter(function(e){return""!==e&&"."!==e}).join("/")}e.read=function(e,t){return t=t||{},n(e).then(function(e){if(e){var n=t.encoding;return s.data.get(e.fid).then(function(e){var t=e&&e.text||"",r=e&&e.encoding||"";return r?n?Buffer.from(t,r).toString(n):Buffer.from(t,r):"utf8"===n?t:n?Buffer.from(t).toString(n):Buffer.from(t)})}return null})},e.rmdir=r,e.rm=function(t){return s.files.get({path:t}).then(function(e){return e?(GlobalEmitter.emit("::remove",{file:e}),s.files.update(e.id,{deleted:!0,ctimeMs:Date.now(),remotePath:null,remoteHash:null}).then(function(){return f(t)})):r(t)})},e.readlink=function(e){return a(e).then(function(e){return e&&e.target})},e.writelink=function(e,t){return r=t.toString("utf8"),n=e,u(n,"",{target:r}).then(function(e){return{mode:e.mode,type:"symlink",target:r,size:0,mtimeMs:e.mtimeMs}});var r,n},e.write=u,e.exists=function(t){return n(t).then(function(e){return!!e||function t(e){return s.folders.get({path:e}).then(function(e){return e&&e.deleted?null:e&&e.target?t(e.target):e})}(t).then(function(e){return!!e})})},e.mkdir=i,e.readdir=function(r){return t(r,!0).then(function(e){var t=r.length+1;return e.map(function(e){return e.slice(t)}).filter(function(e){return-1===e.indexOf("/")}).sort(l)})},e.readdirDeep=function(e){return t(e,!1)},e.lstat=a,e.lock=function r(n,i){i=void 0===i?3:i;if(o[n])return clearTimeout(o[n]),void delete o[n];if(0===i)throw new GitError(E.AcquireLockFileFail,{filename:n});return(e=n+".lock",t=Date.now(),s.folders.add({id:c(),path:e,mtimeMs:t,ctimeMs:t})).catch(function(){return new Promise(function(e,t){setTimeout(function(){r(n,i-1).then(e,t)},100)})});var e,t},e.unlock=function(e,t){if(t=t||50,o[e])throw new GitError(E.DoubleReleaseLockFileFail,{filename:e});o.set(e,setTimeout(function(){return delete o[e],s.folders.where("path").equals(e).modify({deleted:!0})},t))}}var FileType={FILE:32768,DIRECTORY:16384,SYMLINK:40960};function Stats(e,t,r,n,i,o,u,f){var a=this;a.size=t;var l=0;if("number"!=typeof n&&(n=l=Date.now()),"number"!=typeof i&&(l||(l=Date.now()),i=l),"number"!=typeof o&&(l||(l=Date.now()),o=l),"number"!=typeof u&&(l||(l=Date.now()),u=l),a.atimeMs=n,a.ctimeMs=o,a.mtimeMs=i,a.birthtimeMs=u,a.target=f,a.uid=0,a.gid=0,a.ino=0,r)a.mode=m(r);else switch(e){case FileType.FILE:a.mode=m(33188);break;case FileType.DIRECTORY:default:a.mode=m(16384)}function m(e){var t=0<e?e>>12:0;4!==t&&8!==t&&10!==t&&14!==t&&(t=8);var r=511&e;return r=73&r?493:420,8!==t&&(r=0),(t<<12)+r}Object.defineProperties(a,{atime:{get:function(){return new Date(a.atimeMs)}},mtime:{get:function(){return new Date(a.mtimeMs)}},ctime:{get:function(){return new Date(a.ctimeMs)}},birthtime:{get:function(){return new Date(a.birthtimeMs)}}}),a.isFile=function(){return(61440&a.mode)===FileType.FILE},a.isDirectory=function(){return(61440&a.mode)===FileType.DIRECTORY},a.isSymbolicLink=function(){return(61440&a.mode)===FileType.SYMLINK},a.toBuffer=function(){var e=Buffer.alloc(32);return e.writeUInt32LE(a.size,0),e.writeUInt32LE(a.mode,4),e.writeDoubleLE(a.atime.getTime(),8),e.writeDoubleLE(a.mtime.getTime(),16),e.writeDoubleLE(a.ctime.getTime(),24),e},a.chmod=function(e){this.mode=61440&a.mode|e}}function toArrayBuffer(e){if(e instanceof Uint8Array){if(0===e.byteOffset&&e.byteLength===e.buffer.byteLength)return e.buffer;if("function"==typeof e.buffer.slice)return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}if(Buffer.isBuffer(e)){for(var t=new Uint8Array(e.length),r=e.length,n=0;n<r;n++)t[n]=e[n];return t.buffer}throw new Error("Argument must be a Buffer")}