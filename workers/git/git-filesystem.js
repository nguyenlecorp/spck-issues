function GitFileSystemClass(){function e(e){return e.split("/").reduce(function(e,t,n,r){if(0===n)return e;var i=r.slice(0,n+1).join("/");return e.then(function(){return m.folders.get({path:i}).then(function(e){return e?e.deleted?m.folders.update(e.id,{deleted:!1}):void 0:s(i)})})},Promise.resolve())}function t(e){return m.folders.get({path:e}).then(function(t){if(t)return GlobalEmitter.emit("::remove",{folder:t}),m.folders.update(t.id,{deleted:!0}).then(function(){return Promise.all([m.files.where("path").startsWith(e+"/").modify({deleted:!0,ctimeMs:Date.now(),remotePath:null,remoteHash:null}),m.folders.where("path").startsWith(e+"/").modify({deleted:!0})])}).then(function(){return n(e)})})}function n(e){var n=e.slice(0,e.lastIndexOf("/"));return m.files.where("path").startsWith(n+"/").and(function(e){return!e.deleted}).toArray().then(function(e){if(0===e.length)return t(n)})}function r(e,t){return e=a(e)+"/",Promise.resolve(t?m.folders.where("path").startsWith(e).toArray():[]).then(function(t){return m.files.where("path").startsWith(e).toArray().then(function(e){var n=[];return t&&(n=n.concat(t)),e&&(n=n.concat(e)),n.filter(function(e){return!e.deleted}).map(function(e){return e.path})})})}function i(e,t){if(t=void 0===t?3:t,p[e])return clearTimeout(p[e]),void delete p[e];if(0===t)throw new GitError(E.AcquireLockFileFail,{filename:e});return s(e+".lock").catch(function(){return new Promise(function(n,r){setTimeout(function(){i(e,t-1).then(n,r)},100)})})}function o(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function f(e){return sha1(Buffer.concat([Buffer.from("blob "+e.buffer.byteLength.toString()+"\0"),e]))}function u(e,t){return-(e<t)||+(e>t)}function a(e){if(e.indexOf("\0")>=0)throw new Error("Path must be a string without null bytes.");if(""===e)throw new Error("Path must not be empty.");return e.split("/").filter(function(e){return""!==e&&"."!==e}).join("/")}function l(e){var t=e.lastIndexOf("/");return-1===t?".":0===t?"/":e.slice(0,t)}function s(e){return m.folders.add({id:o(),path:e})}function c(){}function d(e){return e&&e.buffer instanceof ArrayBuffer&&void 0!==e.byteLength}var m=ProjectStore,h=this,p={};h._readFile=!0,h.readFile=c,h.rmdir=c,h.stat=c,h.unlink=c,h.writeFile=c,h.exists=function(e){return m.files.get({path:e}).then(function(t){return!(!t||t.deleted)||m.folders.get({path:e}).then(function(e){return e&&!e.deleted})})},h.read=function(e,t){return t=t||{},m.files.get({path:e}).then(function(e){if(e){var n=t.encoding;return m.data.get(e.fid).then(function(e){var t=e&&e.text||"",r=e&&e.encoding||"";return r?n?Buffer.from(t,r).toString(n):Buffer.from(t,r):"utf8"===n?t:n?Buffer.from(t).toString(n):Buffer.from(t)})}return null})},h.write=function(t,n,r){return r=r||{},e(l(t)).then(function(){var e,r={},i=Buffer.from(n);return m.files.get({path:t}).then(function(n){var u=f(i),a=Date.now();if(n){var l=n.ctimeMs||a;return r.fid=n.fid,e={id:n.id,fid:n.fid,path:t,deleted:!1,hash:u,remoteHash:u,remotePath:t,ctimeMs:l,mtimeMs:a},m.files.update(n.id,{deleted:!1,hash:u,remoteHash:u,remotePath:t,ctimeMs:l,mtimeMs:a})}var s=r.fid=o();return e={id:s,fid:s,path:t,hash:u,remoteHash:u,remotePath:t,ctimeMs:a,mtimeMs:a},m.files.put(e)}).then(function(){return d(n)?(r.remoteText=r.text=toArrayBuffer(i),r.remoteEncoding=r.encoding="binary"):"string"==typeof n&&(r.remoteText=r.text=n),m.data.put(r)}).then(function(t){return GlobalEmitter.emit("::write",{file:e}),t})})},h.mkdir=e,h.rm=function(e){return m.files.get({path:e}).then(function(r){return r?(GlobalEmitter.emit("::remove",{file:r}),m.files.update(r.id,{deleted:!0,ctimeMs:Date.now(),remotePath:null,remoteHash:null}).then(function(){return n(e)})):t(e)})},h.readdir=function(e){return r(e,!0).then(function(t){var n=e.length+1;return t.map(function(e){return e.slice(n)}).filter(function(e){return-1===e.indexOf("/")}).sort(u)})},h.readdirDeep=function(e){return r(e,!1)},h.lstat=function(e){return-1===(e=a(e)).indexOf("/")?new Stats(FileType.DIRECTORY,0):m.files.get({path:e}).then(function(t){return t?new Stats(FileType.FILE,1,null,0,t.mtimeMs,t.ctimeMs):m.folders.get({path:e}).then(function(e){return e?new Stats(FileType.DIRECTORY,0):null})})},h.writelink=function(e,t){},h.readlink=function(e){},h.lock=i,h.unlock=function(e,t){if(t=t||50,p[e])throw new GitError(E.DoubleReleaseLockFileFail,{filename:e});p.set(e,setTimeout(function(){return delete p[e],m.folders.where("path").equals(e).modify({deleted:!0})},t))}}function Stats(e,t,n,r,i,o,f){var u=this;u.size=t;var a=0;if("number"!=typeof r&&(r=a=Date.now()),"number"!=typeof i&&(a||(a=Date.now()),i=a),"number"!=typeof o&&(a||(a=Date.now()),o=a),"number"!=typeof f&&(a||(a=Date.now()),f=a),u.atimeMs=r,u.ctimeMs=o,u.mtimeMs=i,u.birthtimeMs=f,u.uid=0,u.gid=0,u.ino=0,n)u.mode=n;else switch(e){case FileType.FILE:u.mode=420;break;case FileType.DIRECTORY:default:u.mode=511}u.mode<4096&&(u.mode|=e),Object.defineProperties(u,{atime:{get:function(){return new Date(u.atimeMs)}},mtime:{get:function(){return new Date(u.mtimeMs)}},ctime:{get:function(){return new Date(u.ctimeMs)}},birthtime:{get:function(){return new Date(u.birthtimeMs)}}}),u.isFile=function(){return(61440&u.mode)===FileType.FILE},u.isDirectory=function(){return(61440&u.mode)===FileType.DIRECTORY},u.isSymbolicLink=function(){return(61440&u.mode)===FileType.SYMLINK},u.toBuffer=function(){var e=Buffer.alloc(32);return e.writeUInt32LE(u.size,0),e.writeUInt32LE(u.mode,4),e.writeDoubleLE(u.atime.getTime(),8),e.writeDoubleLE(u.mtime.getTime(),16),e.writeDoubleLE(u.ctime.getTime(),24),e},u.chmod=function(e){this.mode=61440&u.mode|e}}function toArrayBuffer(e){if(e instanceof Uint8Array){if(0===e.byteOffset&&e.byteLength===e.buffer.byteLength)return e.buffer;if("function"==typeof e.buffer.slice)return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}if(Buffer.isBuffer(e)){for(var t=new Uint8Array(e.length),n=e.length,r=0;r<n;r++)t[r]=e[r];return t.buffer}throw new Error("Argument must be a Buffer")}var GitFileSystem=new GitFileSystemClass,FileType={FILE:32768,DIRECTORY:16384,SYMLINK:40960};