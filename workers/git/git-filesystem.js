var GitFileSystem=new GitFileSystemClass;function GitFileSystemClass(){var c=ProjectStore,e=this,o={};function n(e){return e.split("/").reduce(function(e,t,r,n){if(0===r)return e;var i=n.slice(0,r+1).join("/");return e.then(function(){return c.folders.get({path:i}).then(function(e){return e?e.deleted?c.folders.update(e.id,{deleted:!1}):void 0:a(i)})})},Promise.resolve())}function r(t){return c.folders.get({path:t}).then(function(e){if(e)return GlobalEmitter.emit("::remove",{folder:e}),c.folders.update(e.id,{deleted:!0}).then(function(){return Promise.all([c.files.where("path").startsWith(t+"/").modify({deleted:!0,ctimeMs:Date.now(),remotePath:null,remoteHash:null}),c.folders.where("path").startsWith(t+"/").modify({deleted:!0})])}).then(function(){return i(t)})})}function i(e){var t=e.slice(0,e.lastIndexOf("/"));return c.files.where("path").startsWith(t+"/").and(function(e){return!e.deleted}).toArray().then(function(e){if(0===e.length)return r(t)})}function t(e,t){return e=u(e)+"/",Promise.resolve(t?c.folders.where("path").startsWith(e).toArray():[]).then(function(r){return c.files.where("path").startsWith(e).toArray().then(function(e){var t=[];return r&&(t=t.concat(r)),e&&(t=t.concat(e)),t.filter(function(e){return!e.deleted}).map(function(e){return e.path})})})}function d(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function f(e,t){return-(e<t)||+(t<e)}function u(e){if(0<=e.indexOf("\0"))throw new Error("Path must be a string without null bytes.");if(""===e)throw new Error("Path must not be empty.");return e.split("/").filter(function(e){return""!==e&&"."!==e}).join("/")}function a(e){return c.folders.add({id:d(),path:e})}function l(){}e._readFile=!0,e.readFile=l,e.rmdir=l,e.stat=l,e.unlink=l,e.writeFile=l,e.exists=function(t){return c.files.get({path:t}).then(function(e){return!(!e||e.deleted)||c.folders.get({path:t}).then(function(e){return e&&!e.deleted})})},e.read=function(e,t){return t=t||{},c.files.get({path:e}).then(function(e){if(e){var n=t.encoding;return c.data.get(e.fid).then(function(e){var t=e&&e.text||"",r=e&&e.encoding||"";return r?n?Buffer.from(t,r).toString(n):Buffer.from(t,r):"utf8"===n?t:n?Buffer.from(t).toString(n):Buffer.from(t)})}return null})},e.write=function(l,t,s){return s=s||{},n((e=l,r=e.lastIndexOf("/"),-1===r?".":0===r?"/":e.slice(0,r))).then(function(){var f,u={},a=Buffer.from(t);return c.files.get({path:l}).then(function(e){var t,r=(t=a,sha1(Buffer.concat([Buffer.from("blob "+t.buffer.byteLength.toString()+"\0"),t]))),n=Date.now();if(e){var i=e.ctimeMs||n;return u.fid=e.fid,f={id:e.id,fid:e.fid,path:l,deleted:!1,hash:r,remoteHash:r,remotePath:l,mode:s.mode,ctimeMs:i,mtimeMs:n},c.files.update(e.id,{deleted:!1,hash:r,remoteHash:r,remotePath:l,mode:s.mode,ctimeMs:i,mtimeMs:n})}var o=u.fid=d();return f={id:o,fid:o,path:l,hash:r,remoteHash:r,remotePath:l,mode:s.mode,ctimeMs:n,mtimeMs:n},c.files.put(f)}).then(function(){var e;return(e=t)&&e.buffer instanceof ArrayBuffer&&void 0!==e.byteLength?(u.remoteText=u.text=toArrayBuffer(a),u.remoteEncoding=u.encoding="binary"):"string"==typeof t&&(u.remoteText=u.text=t),c.data.put(u)}).then(function(e){return GlobalEmitter.emit("::write",{file:f}),e})});var e,r},e.mkdir=n,e.rm=function(t){return c.files.get({path:t}).then(function(e){return e?(GlobalEmitter.emit("::remove",{file:e}),c.files.update(e.id,{deleted:!0,ctimeMs:Date.now(),remotePath:null,remoteHash:null}).then(function(){return i(t)})):r(t)})},e.readdir=function(r){return t(r,!0).then(function(e){var t=r.length+1;return e.map(function(e){return e.slice(t)}).filter(function(e){return-1===e.indexOf("/")}).sort(f)})},e.readdirDeep=function(e){return t(e,!1)},e.lstat=function(t){return-1===(t=u(t)).indexOf("/")?new Stats(FileType.DIRECTORY,0):c.files.get({path:t}).then(function(e){return e?new Stats(FileType.FILE,1,e.mode,0,e.mtimeMs,e.ctimeMs):c.folders.get({path:t}).then(function(e){return e?new Stats(FileType.DIRECTORY,0):null})})},e.writelink=function(e,t){},e.readlink=function(e){},e.lock=function r(n,i){i=void 0===i?3:i;if(o[n])return clearTimeout(o[n]),void delete o[n];if(0===i)throw new GitError(E.AcquireLockFileFail,{filename:n});return a(n+".lock").catch(function(){return new Promise(function(e,t){setTimeout(function(){r(n,i-1).then(e,t)},100)})})},e.unlock=function(e,t){if(t=t||50,o[e])throw new GitError(E.DoubleReleaseLockFileFail,{filename:e});o.set(e,setTimeout(function(){return delete o[e],c.folders.where("path").equals(e).modify({deleted:!0})},t))}}var FileType={FILE:32768,DIRECTORY:16384,SYMLINK:40960};function Stats(e,t,r,n,i,o,f){var u=this;u.size=t;var a=0;if("number"!=typeof n&&(n=a=Date.now()),"number"!=typeof i&&(a||(a=Date.now()),i=a),"number"!=typeof o&&(a||(a=Date.now()),o=a),"number"!=typeof f&&(a||(a=Date.now()),f=a),u.atimeMs=n,u.ctimeMs=o,u.mtimeMs=i,u.birthtimeMs=f,u.uid=0,u.gid=0,u.ino=0,r)u.mode=l(r);else switch(e){case FileType.FILE:u.mode=l(33188);break;case FileType.DIRECTORY:default:u.mode=l(16384)}function l(e){var t=0<e?e>>12:0;4!==t&&8!==t&&10!==t&&14!==t&&(t=8);var r=511&e;return r=73&r?493:420,8!==t&&(r=0),(t<<12)+r}Object.defineProperties(u,{atime:{get:function(){return new Date(u.atimeMs)}},mtime:{get:function(){return new Date(u.mtimeMs)}},ctime:{get:function(){return new Date(u.ctimeMs)}},birthtime:{get:function(){return new Date(u.birthtimeMs)}}}),u.isFile=function(){return(61440&u.mode)===FileType.FILE},u.isDirectory=function(){return(61440&u.mode)===FileType.DIRECTORY},u.isSymbolicLink=function(){return(61440&u.mode)===FileType.SYMLINK},u.toBuffer=function(){var e=Buffer.alloc(32);return e.writeUInt32LE(u.size,0),e.writeUInt32LE(u.mode,4),e.writeDoubleLE(u.atime.getTime(),8),e.writeDoubleLE(u.mtime.getTime(),16),e.writeDoubleLE(u.ctime.getTime(),24),e},u.chmod=function(e){this.mode=61440&u.mode|e}}function toArrayBuffer(e){if(e instanceof Uint8Array){if(0===e.byteOffset&&e.byteLength===e.buffer.byteLength)return e.buffer;if("function"==typeof e.buffer.slice)return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}if(Buffer.isBuffer(e)){for(var t=new Uint8Array(e.length),r=e.length,n=0;n<r;n++)t[n]=e[n];return t.buffer}throw new Error("Argument must be a Buffer")}