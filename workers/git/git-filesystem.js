function GitFileSystemClass(){function e(t){return w.folders.get({path:t}).then(function(t){return t&&t.deleted?null:t&&t.target?e(t.target):t})}function t(e){return w.files.get({path:e}).then(function(e){return e&&e.deleted?null:e&&e.target?t(e.target):e})}function n(e){var t=e.split("/").map(function(e,t,n){return n.slice(0,t+1).join("/")});return w.folders.where("path").anyOf(t).keys(function(e){return g(t.filter(function(t){return-1===e.indexOf(t)}))})}function r(e,r,i){return i=i||{},n(h(e)).then(function(){var n,u={},o=Buffer.from(r);return t(e).then(function(t){var r=s(o),f=Date.now();if(t){var a=t.ctimeMs||f;return u.fid=t.fid,n={id:t.id,fid:t.fid,path:e,deleted:!1,hash:r,remoteHash:r,remotePath:e,mode:i.mode,target:i.target,ctimeMs:a,mtimeMs:f},w.files.update(t.id,{deleted:!1,hash:r,remoteHash:r,remotePath:e,mode:i.mode,target:i.target,ctimeMs:a,mtimeMs:f})}var l=u.fid=m();return n={id:l,fid:l,path:e,hash:r,remoteHash:r,remotePath:e,mode:i.mode,target:i.target,ctimeMs:f,mtimeMs:f},w.files.put(n)}).then(function(){return y(r)?(u.remoteText=u.text=toArrayBuffer(o),u.remoteEncoding=u.encoding="binary"):"string"==typeof r&&(u.remoteText=u.text=r),w.data.put(u)}).then(function(){return GlobalEmitter.emit("::write",{file:n}),{mode:n.mode,type:"file",size:u.text.length,mtimeMs:n.mtimeMs,ino:0}})})}function i(e){return w.folders.get({path:e}).then(function(t){if(t)return GlobalEmitter.emit("::remove",{folder:t}),w.folders.update(t.id,{deleted:!0}).then(function(){return Promise.all([w.files.where("path").startsWith(e+"/").modify({deleted:!0,ctimeMs:Date.now(),remotePath:null,remoteHash:null}),w.folders.where("path").startsWith(e+"/").modify({deleted:!0})])}).then(function(){return u(e)})})}function u(e){var t=e.slice(0,e.lastIndexOf("/"));return w.files.where("path").startsWith(t+"/").and(function(e){return!e.deleted}).toArray().then(function(e){if(0===e.length)return i(t)})}function o(e,t){return e=d(e)+"/",Promise.resolve(t?w.folders.where("path").startsWith(e).toArray():[]).then(function(t){return w.files.where("path").startsWith(e).toArray().then(function(e){var n=[];return t&&(n=n.concat(t)),e&&(n=n.concat(e)),n.filter(function(e){return!e.deleted}).map(function(e){return e.path})})})}function f(e){return-1===(e=d(e)).indexOf("/")?new Stats(FileType.DIRECTORY,0):w.files.get({path:e}).then(function(t){return t?new Stats(FileType.FILE,1,t.mode,null,t.mtimeMs,t.ctimeMs,null,t.target):w.folders.get({path:e}).then(function(e){return e?new Stats(FileType.DIRECTORY,0,null,null,e.mtimeMs,e.ctimeMs,null,e.target):null})})}function a(e,t){return r(t,"",{target:e}).then(function(t){return{mode:t.mode,type:"symlink",target:e,size:0,mtimeMs:t.mtimeMs}})}function l(e,t){if(t=void 0===t?3:t,b[e])return clearTimeout(b[e]),void delete b[e];if(0===t)throw new GitError(E.AcquireLockFileFail,{filename:e});return p(e+".lock").catch(function(){return new Promise(function(n,r){setTimeout(function(){l(e,t-1).then(n,r)},100)})})}function m(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function s(e){return sha1(Buffer.concat([Buffer.from("blob "+e.buffer.byteLength.toString()+"\0"),e]))}function c(e,t){return-(e<t)||+(e>t)}function d(e){if(e.indexOf("\0")>=0)throw new Error("Path must be a string without null bytes.");if(""===e)throw new Error("Path must not be empty.");return e.split("/").filter(function(e){return""!==e&&"."!==e}).join("/")}function h(e){var t=e.lastIndexOf("/");return-1===t?".":0===t?"/":e.slice(0,t)}function g(e){var t=Date.now(),n=e.map(function(e){return{id:m(),path:e,mtimeMs:t,ctimeMs:t}});return w.folders.bulkAdd(n)}function p(e){var t=Date.now();return w.folders.add({id:m(),path:e,mtimeMs:t,ctimeMs:t})}function y(e){return e&&e.buffer instanceof ArrayBuffer&&void 0!==e.byteLength}var w=ProjectStore,x=this,b={};x.read=function(e,n){return n=n||{},t(e).then(function(e){if(e){var t=n.encoding;return w.data.get(e.fid).then(function(e){var n=e&&e.text||"",r=e&&e.encoding||"";return r?t?Buffer.from(n,r).toString(t):Buffer.from(n,r):"utf8"===t?n:t?Buffer.from(n).toString(t):Buffer.from(n)})}return null})},x.rmdir=i,x.rm=function(e){return w.files.get({path:e}).then(function(t){return t?(GlobalEmitter.emit("::remove",{file:t}),w.files.update(t.id,{deleted:!0,ctimeMs:Date.now(),remotePath:null,remoteHash:null}).then(function(){return u(e)})):i(e)})},x.readlink=function(e){return f(e).then(function(e){return e&&e.target})},x.writelink=function(e,t){return a(t.toString("utf8"),e)},x.write=r,x.exists=function(n){return t(n).then(function(t){return!!t||e(n).then(function(e){return!!e})})},x.mkdir=n,x.readdir=function(e){return o(e,!0).then(function(t){var n=e.length+1;return t.map(function(e){return e.slice(n)}).filter(function(e){return-1===e.indexOf("/")}).sort(c)})},x.readdirDeep=function(e){return o(e,!1)},x.lstat=f,x.lock=l,x.unlock=function(e,t){if(t=t||50,b[e])throw new GitError(E.DoubleReleaseLockFileFail,{filename:e});b.set(e,setTimeout(function(){return delete b[e],w.folders.where("path").equals(e).modify({deleted:!0})},t))}}function Stats(e,t,n,r,i,u,o,f){function a(e){var t=e>0?e>>12:0;4!==t&&8!==t&&10!==t&&14!==t&&(t=8);var n=511&e;return n=73&n?493:420,8!==t&&(n=0),(t<<12)+n}var l=this;l.size=t;var m=0;if("number"!=typeof r&&(r=m=Date.now()),"number"!=typeof i&&(m||(m=Date.now()),i=m),"number"!=typeof u&&(m||(m=Date.now()),u=m),"number"!=typeof o&&(m||(m=Date.now()),o=m),l.atimeMs=r,l.ctimeMs=u,l.mtimeMs=i,l.birthtimeMs=o,l.target=f,l.uid=0,l.gid=0,l.ino=0,n)l.mode=a(n);else switch(e){case FileType.FILE:l.mode=a(33188);break;case FileType.DIRECTORY:default:l.mode=a(16384)}Object.defineProperties(l,{atime:{get:function(){return new Date(l.atimeMs)}},mtime:{get:function(){return new Date(l.mtimeMs)}},ctime:{get:function(){return new Date(l.ctimeMs)}},birthtime:{get:function(){return new Date(l.birthtimeMs)}}}),l.isFile=function(){return(61440&l.mode)===FileType.FILE},l.isDirectory=function(){return(61440&l.mode)===FileType.DIRECTORY},l.isSymbolicLink=function(){return(61440&l.mode)===FileType.SYMLINK},l.toBuffer=function(){var e=Buffer.alloc(32);return e.writeUInt32LE(l.size,0),e.writeUInt32LE(l.mode,4),e.writeDoubleLE(l.atime.getTime(),8),e.writeDoubleLE(l.mtime.getTime(),16),e.writeDoubleLE(l.ctime.getTime(),24),e},l.chmod=function(e){this.mode=61440&l.mode|e}}function toArrayBuffer(e){if(e instanceof Uint8Array){if(0===e.byteOffset&&e.byteLength===e.buffer.byteLength)return e.buffer;if("function"==typeof e.buffer.slice)return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}if(Buffer.isBuffer(e)){for(var t=new Uint8Array(e.length),n=e.length,r=0;r<n;r++)t[r]=e[r];return t.buffer}throw new Error("Argument must be a Buffer")}var GitFileSystem=new GitFileSystemClass,FileType={FILE:32768,DIRECTORY:16384,SYMLINK:40960};