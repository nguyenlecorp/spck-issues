!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","vscode-languageserver-types","../parser/htmlScanner","../parser/htmlTags","./tagProviders","../parser/htmlEntities","vscode-nls","../utils/strings"],e)}(function(e,t){"use strict";function n(e){return/^\s*$/.test(e)}function r(e,t,n,r){for(var a=s.createScanner(e,t,n),o=a.scan();o===s.TokenType.Whitespace;)o=a.scan();return o===r}function a(e,t,r){for(;t>r&&!n(e[t-1]);)t--;return t}function o(e,t,r){for(;t<r&&!n(e[t]);)t++;return t}Object.defineProperty(t,"__esModule",{value:!0});var i=e("vscode-languageserver-types"),s=e("../parser/htmlScanner"),T=e("../parser/htmlTags"),f=e("./tagProviders"),c=e("../parser/htmlEntities"),u=e("vscode-nls"),d=e("../utils/strings"),l=u.loadMessageBundle();t.doComplete=function(e,t,u,g){function p(t,n){return void 0===n&&(n=F),t>F&&(t=F),{start:e.positionAt(t),end:e.positionAt(n)}}function k(e,t){var n=p(e,t);return C.forEach(function(e){e.collectTags(function(e,t){A.items.push({label:e,kind:i.CompletionItemKind.Property,documentation:t,textEdit:i.TextEdit.replace(n,e),insertTextFormat:i.InsertTextFormat.PlainText})})}),A}function m(e){for(var t=e;t>0;){var r=I.charAt(t-1);if("\n\r".indexOf(r)>=0)return I.substring(t,e);if(!n(r))return null;t--}return I.substring(0,e)}function E(e,t,n){void 0===n&&(n=F);var a=p(e,n),o=r(I,n,s.ScannerState.WithinEndTag,s.TokenType.EndTagClose)?"":">",T=P;for(t&&(T=T.parent);T;){var f=T.tag;if(f&&(!T.closed||T.endTagStart>F)){var c={label:"/"+f,kind:i.CompletionItemKind.Property,filterText:"/"+f+o,textEdit:i.TextEdit.replace(a,"/"+f+o),insertTextFormat:i.InsertTextFormat.PlainText},u=m(T.start),d=m(e-1);if(null!==u&&null!==d&&u!==d){var l=u+"</"+f+o;c.textEdit=i.TextEdit.replace(p(e-1-d.length),l),c.filterText=d+"</"+f+o}return A.items.push(c),A}T=T.parent}return t?A:(C.forEach(function(e){e.collectTags(function(e,t){A.items.push({label:"/"+e,kind:i.CompletionItemKind.Property,documentation:t,filterText:"/"+e+o,textEdit:i.TextEdit.replace(a,"/"+e+o),insertTextFormat:i.InsertTextFormat.PlainText})})}),A)}function x(e,t){return k(e,t),E(e,!0,t),A}function v(e,t){void 0===t&&(t=F);for(var n=F;n<t&&"<"!==I[n];)n++;var a=p(e,n),o=r(I,t,s.ScannerState.AfterAttributeName,s.TokenType.DelimiterAssign)?"":'="$1"',T=W.toLowerCase();return C.forEach(function(e){e.collectAttributes(T,function(e,t){var n,r=e;"v"!==t&&o.length&&(r+=o,t&&(n={title:"Suggest",command:"editor.action.triggerSuggest"})),A.items.push({label:e,kind:"handler"===t?i.CompletionItemKind.Function:i.CompletionItemKind.Value,textEdit:i.TextEdit.replace(a,r),insertTextFormat:i.InsertTextFormat.Snippet,command:n})})}),S(a),A}function S(e){function t(e){e.attributeNames.forEach(function(e){d.startsWith(e,n)&&!r[e]&&(r[e]=e+'="$1"')}),e.children.forEach(function(e){return t(e)})}var n="data-",r={};r[n]=n+'$1="$2"',u&&u.roots.forEach(function(e){return t(e)}),Object.keys(r).forEach(function(t){return A.items.push({label:t,kind:i.CompletionItemKind.Value,textEdit:i.TextEdit.replace(e,r[t]),insertTextFormat:i.InsertTextFormat.Snippet})})}function h(e,t){void 0===t&&(t=F);var n,r;if(F>e&&F<=t&&'"'===I[e]){t>F&&'"'===I[t-1]&&t--;var s=a(I,F,e+1),T=o(I,F,t);n=p(s,T),r=!1}else n=p(e,t),r=!0;var f=W.toLowerCase(),c=K.toLowerCase();return C.forEach(function(e){e.collectValues(f,c,function(e){var t=r?'"'+e+'"':e;A.items.push({label:e,filterText:t,kind:i.CompletionItemKind.Unit,textEdit:i.TextEdit.replace(n,t),insertTextFormat:i.InsertTextFormat.PlainText})})}),O(),A}function y(e){return F===N.getTokenEnd()&&($=N.scan())===e&&N.getTokenOffset()===F?N.getTokenEnd():F}function b(){return O()}function O(){for(var e=F-1,n=t.character;e>=0&&d.isLetterOrDigit(I,e);)e--,n--;if(e>=0&&"&"===I[e]){var r=i.Range.create(i.Position.create(t.line,n-1),t);for(var a in c.entities)if(d.endsWith(a,";")){var o="&"+a;A.items.push({label:o,kind:i.CompletionItemKind.Keyword,documentation:l("entity.propose","Character entity representing '"+c.entities[a]+"'"),textEdit:i.TextEdit.replace(r,o),insertTextFormat:i.InsertTextFormat.PlainText})}}return A}var A={isIncomplete:!1,items:[]},C=f.allTagProviders.filter(function(t){return t.isApplicable(e.languageId)&&(!g||!1!==g[t.getId()])}),I=e.getText(),F=e.offsetAt(t),P=u.findNodeBefore(F);if(!P)return A;for(var K,N=s.createScanner(I,P.start),W="",$=N.scan();$!==s.TokenType.EOS&&N.getTokenOffset()<=F;){switch($){case s.TokenType.StartTagOpen:if(N.getTokenEnd()===F){var w=y(s.TokenType.StartTag);return x(F,w)}break;case s.TokenType.StartTag:if(N.getTokenOffset()<=F&&F<=N.getTokenEnd())return k(N.getTokenOffset(),N.getTokenEnd());W=N.getTokenText();break;case s.TokenType.AttributeName:if(N.getTokenOffset()<=F&&F<=N.getTokenEnd())return v(N.getTokenOffset(),N.getTokenEnd());K=N.getTokenText();break;case s.TokenType.DelimiterAssign:if(N.getTokenEnd()===F)return h(N.getTokenEnd());break;case s.TokenType.AttributeValue:if(N.getTokenOffset()<=F&&F<=N.getTokenEnd())return h(N.getTokenOffset(),N.getTokenEnd());break;case s.TokenType.Whitespace:if(F<=N.getTokenEnd())switch(N.getScannerState()){case s.ScannerState.AfterOpeningStartTag:return x(N.getTokenOffset(),y(s.TokenType.StartTag));case s.ScannerState.WithinTag:case s.ScannerState.AfterAttributeName:return v(N.getTokenEnd());case s.ScannerState.BeforeAttributeValue:return h(N.getTokenEnd());case s.ScannerState.AfterOpeningEndTag:return E(N.getTokenOffset()-1,!1);case s.ScannerState.WithinContent:return b()}break;case s.TokenType.EndTagOpen:if(F<=N.getTokenEnd())return E(N.getTokenOffset()+1,!1,y(s.TokenType.EndTag));break;case s.TokenType.EndTag:if(F<=N.getTokenEnd())for(var B=N.getTokenOffset()-1;B>=0;){var V=I.charAt(B);if("/"===V)return E(B,!1,N.getTokenEnd());if(!n(V))break;B--}break;case s.TokenType.StartTagClose:if(F<=N.getTokenEnd()&&W)return function(t,n){if(g&&g.hideAutoCompleteProposals)return A;if(!T.isEmptyElement(n)){var r=e.positionAt(t);A.items.push({label:"</"+n+">",kind:i.CompletionItemKind.Property,filterText:"</"+n+">",textEdit:i.TextEdit.insert(r,"$0</"+n+">"),insertTextFormat:i.InsertTextFormat.Snippet})}return A}(N.getTokenEnd(),W);break;case s.TokenType.Content:if(F<=N.getTokenEnd())return b();break;default:if(F<=N.getTokenEnd())return A}$=N.scan()}return A},t.doTagComplete=function(e,t,n){var r=e.offsetAt(t);if(r<=0)return null;var a=e.getText().charAt(r-1);if(">"===a){if((o=n.findNodeBefore(r))&&o.tag&&!T.isEmptyElement(o.tag)&&o.start<r&&(!o.endTagStart||o.endTagStart>r))for(f=(i=s.createScanner(e.getText(),o.start)).scan();f!==s.TokenType.EOS&&i.getTokenEnd()<=r;){if(f===s.TokenType.StartTagClose&&i.getTokenEnd()===r)return"$0</"+o.tag+">";f=i.scan()}}else if("/"===a){for(var o=n.findNodeBefore(r);o&&o.closed;)o=o.parent;if(o&&o.tag)for(var i=s.createScanner(e.getText(),o.start),f=i.scan();f!==s.TokenType.EOS&&i.getTokenEnd()<=r;){if(f===s.TokenType.EndTagOpen&&i.getTokenEnd()===r)return o.tag+">";f=i.scan()}}return null}});