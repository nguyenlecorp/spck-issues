!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","vscode-languageserver-types","../parser/htmlScanner","../parser/htmlTags","./tagProviders","../parser/htmlEntities","vscode-nls","../utils/strings"],e)}(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var C=e("vscode-languageserver-types"),I=e("../parser/htmlScanner"),F=e("../parser/htmlTags"),P=e("./tagProviders"),K=e("../parser/htmlEntities"),n=e("vscode-nls"),N=e("../utils/strings"),W=n.loadMessageBundle();function $(e){return/^\s*$/.test(e)}function w(e,t,n,r){for(var a=I.createScanner(e,t,n),o=a.scan();o===I.TokenType.Whitespace;)o=a.scan();return o===r}t.doComplete=function(r,o,f,a){var u={isIncomplete:!1,items:[]},d=P.allTagProviders.filter(function(e){return e.isApplicable(r.languageId)&&(!a||!1!==a[e.getId()])}),l=r.getText(),g=r.offsetAt(o),p=f.findNodeBefore(g);if(!p)return u;var T,t=I.createScanner(l,p.start),c="";function k(e,t){return void 0===t&&(t=g),g<e&&(e=g),{start:r.positionAt(e),end:r.positionAt(t)}}function n(e,t){var n=k(e,t);return d.forEach(function(e){e.collectTags(function(e,t){u.items.push({label:e,kind:C.CompletionItemKind.Property,documentation:t,textEdit:C.TextEdit.replace(n,e),insertTextFormat:C.InsertTextFormat.PlainText})})}),u}function m(e){for(var t=e;0<t;){var n=l.charAt(t-1);if(0<="\n\r".indexOf(n))return l.substring(t,e);if(!$(n))return null;t--}return l.substring(0,e)}function i(e,t,n){void 0===n&&(n=g);var r=k(e,n),a=w(l,n,I.ScannerState.WithinEndTag,I.TokenType.EndTagClose)?"":">",o=p;for(t&&(o=o.parent);o;){var i=o.tag;if(i&&(!o.closed||o.endTagStart>g)){var s={label:"/"+i,kind:C.CompletionItemKind.Property,filterText:"/"+i+a,textEdit:C.TextEdit.replace(r,"/"+i+a),insertTextFormat:C.InsertTextFormat.PlainText},T=m(o.start),f=m(e-1);if(null!==T&&null!==f&&T!==f){var c=T+"</"+i+a;s.textEdit=C.TextEdit.replace(k(e-1-f.length),c),s.filterText=f+"</"+i+a}return u.items.push(s),u}o=o.parent}return t||d.forEach(function(e){e.collectTags(function(e,t){u.items.push({label:"/"+e,kind:C.CompletionItemKind.Property,documentation:t,filterText:"/"+e+a,textEdit:C.TextEdit.replace(r,"/"+e+a),insertTextFormat:C.InsertTextFormat.PlainText})})}),u}function e(e,t){if(a&&a.hideAutoCompleteProposals)return u;if(!F.isEmptyElement(t)){var n=r.positionAt(e);u.items.push({label:"</"+t+">",kind:C.CompletionItemKind.Property,filterText:"</"+t+">",textEdit:C.TextEdit.insert(n,"$0</"+t+">"),insertTextFormat:C.InsertTextFormat.Snippet})}return u}function s(e,t){return n(e,t),i(e,!0,t),u}function E(e,t){void 0===t&&(t=g);for(var n=g;n<t&&"<"!==l[n];)n++;var r,a,o,i=k(e,n),s=w(l,t,I.ScannerState.AfterAttributeName,I.TokenType.DelimiterAssign)?"":'="$1"',T=c.toLowerCase();return d.forEach(function(e){e.collectAttributes(T,function(e,t){var n,r=e;"v"!==t&&s.length&&(r+=s,t&&(n={title:"Suggest",command:"editor.action.triggerSuggest"})),u.items.push({label:e,kind:"handler"===t?C.CompletionItemKind.Function:C.CompletionItemKind.Value,textEdit:C.TextEdit.replace(i,r),insertTextFormat:C.InsertTextFormat.Snippet,command:n})})}),r=i,(o={})[a="data-"]=a+'$1="$2"',f&&f.roots.forEach(function(e){return function t(e){e.attributeNames.forEach(function(e){N.startsWith(e,a)&&!o[e]&&(o[e]=e+'="$1"')}),e.children.forEach(function(e){return t(e)})}(e)}),Object.keys(o).forEach(function(e){return u.items.push({label:e,kind:C.CompletionItemKind.Value,textEdit:C.TextEdit.replace(r,o[e]),insertTextFormat:C.InsertTextFormat.Snippet})}),u}function x(e,t){var n,r;if(void 0===t&&(t=g),e<g&&g<=t&&'"'===l[e]){g<t&&'"'===l[t-1]&&t--;var a=function(e,t,n){for(;n<t&&!$(e[t-1]);)t--;return t}(l,g,e+1),o=function(e,t,n){for(;t<n&&!$(e[t]);)t++;return t}(l,g,t);n=k(a,o),r=!1}else n=k(e,t),r=!0;var i=c.toLowerCase(),s=T.toLowerCase();return d.forEach(function(e){e.collectValues(i,s,function(e){var t=r?'"'+e+'"':e;u.items.push({label:e,filterText:t,kind:C.CompletionItemKind.Unit,textEdit:C.TextEdit.replace(n,t),insertTextFormat:C.InsertTextFormat.PlainText})})}),h(),u}function v(e){return g===t.getTokenEnd()&&(y=t.scan())===e&&t.getTokenOffset()===g?t.getTokenEnd():g}function S(){return h()}function h(){for(var e=g-1,t=o.character;0<=e&&N.isLetterOrDigit(l,e);)e--,t--;if(0<=e&&"&"===l[e]){var n=C.Range.create(C.Position.create(o.line,t-1),o);for(var r in K.entities)if(N.endsWith(r,";")){var a="&"+r;u.items.push({label:a,kind:C.CompletionItemKind.Keyword,documentation:W("entity.propose","Character entity representing '"+K.entities[r]+"'"),textEdit:C.TextEdit.replace(n,a),insertTextFormat:C.InsertTextFormat.PlainText})}}return u}for(var y=t.scan();y!==I.TokenType.EOS&&t.getTokenOffset()<=g;){switch(y){case I.TokenType.StartTagOpen:if(t.getTokenEnd()===g){var b=v(I.TokenType.StartTag);return s(g,b)}break;case I.TokenType.StartTag:if(t.getTokenOffset()<=g&&g<=t.getTokenEnd())return n(t.getTokenOffset(),t.getTokenEnd());c=t.getTokenText();break;case I.TokenType.AttributeName:if(t.getTokenOffset()<=g&&g<=t.getTokenEnd())return E(t.getTokenOffset(),t.getTokenEnd());T=t.getTokenText();break;case I.TokenType.DelimiterAssign:if(t.getTokenEnd()===g)return x(t.getTokenEnd());break;case I.TokenType.AttributeValue:if(t.getTokenOffset()<=g&&g<=t.getTokenEnd())return x(t.getTokenOffset(),t.getTokenEnd());break;case I.TokenType.Whitespace:if(g<=t.getTokenEnd())switch(t.getScannerState()){case I.ScannerState.AfterOpeningStartTag:return s(t.getTokenOffset(),v(I.TokenType.StartTag));case I.ScannerState.WithinTag:case I.ScannerState.AfterAttributeName:return E(t.getTokenEnd());case I.ScannerState.BeforeAttributeValue:return x(t.getTokenEnd());case I.ScannerState.AfterOpeningEndTag:return i(t.getTokenOffset()-1,!1);case I.ScannerState.WithinContent:return S()}break;case I.TokenType.EndTagOpen:if(g<=t.getTokenEnd())return i(t.getTokenOffset()+1,!1,v(I.TokenType.EndTag));break;case I.TokenType.EndTag:if(g<=t.getTokenEnd())for(var O=t.getTokenOffset()-1;0<=O;){var A=l.charAt(O);if("/"===A)return i(O,!1,t.getTokenEnd());if(!$(A))break;O--}break;case I.TokenType.StartTagClose:if(g<=t.getTokenEnd()&&c)return e(t.getTokenEnd(),c);break;case I.TokenType.Content:if(g<=t.getTokenEnd())return S();break;default:if(g<=t.getTokenEnd())return u}y=t.scan()}return u},t.doTagComplete=function(e,t,n){var r=e.offsetAt(t);if(r<=0)return null;var a=e.getText().charAt(r-1);if(">"===a){if((i=n.findNodeBefore(r))&&i.tag&&!F.isEmptyElement(i.tag)&&i.start<r&&(!i.endTagStart||i.endTagStart>r))for(var o=(s=I.createScanner(e.getText(),i.start)).scan();o!==I.TokenType.EOS&&s.getTokenEnd()<=r;){if(o===I.TokenType.StartTagClose&&s.getTokenEnd()===r)return"$0</"+i.tag+">";o=s.scan()}}else if("/"===a){for(var i=n.findNodeBefore(r);i&&i.closed;)i=i.parent;var s;if(i&&i.tag)for(o=(s=I.createScanner(e.getText(),i.start)).scan();o!==I.TokenType.EOS&&s.getTokenEnd()<=r;){if(o===I.TokenType.EndTagOpen&&s.getTokenEnd()===r)return i.tag+">";o=s.scan()}}return null}});