!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","vscode-languageserver-types","../parser/htmlScanner","../parser/htmlTags","./tagProviders","../parser/htmlEntities","vscode-nls","../utils/strings"],e)}((function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=e("vscode-languageserver-types"),r=e("../parser/htmlScanner"),a=e("../parser/htmlTags"),o=e("./tagProviders"),i=e("../parser/htmlEntities"),s=e("vscode-nls"),T=e("../utils/strings"),f=s.loadMessageBundle();function c(e){return/^\s*$/.test(e)}function u(e,t,n,a){for(var o=r.createScanner(e,t,n),i=o.scan();i===r.TokenType.Whitespace;)i=o.scan();return i===a}t.doComplete=function(e,t,s,d){var l={isIncomplete:!1,items:[]},g=o.allTagProviders.filter((function(t){return t.isApplicable(e.languageId)&&(!d||!1!==d[t.getId()])})),p=e.getText(),k=e.offsetAt(t),m=s.findNodeBefore(k);if(!m)return l;var E,x=r.createScanner(p,m.start),v="";function S(t,n){return void 0===n&&(n=k),t>k&&(t=k),{start:e.positionAt(t),end:e.positionAt(n)}}function h(e,t){var r=S(e,t);return g.forEach((function(e){e.collectTags((function(e,t){l.items.push({label:e,kind:n.CompletionItemKind.Property,documentation:t,textEdit:n.TextEdit.replace(r,e),insertTextFormat:n.InsertTextFormat.PlainText})}))})),l}function y(e){for(var t=e;t>0;){var n=p.charAt(t-1);if("\n\r".indexOf(n)>=0)return p.substring(t,e);if(!c(n))return null;t--}return p.substring(0,e)}function b(e,t,a){void 0===a&&(a=k);var o=S(e,a),i=u(p,a,r.ScannerState.WithinEndTag,r.TokenType.EndTagClose)?"":">",s=m;for(t&&(s=s.parent);s;){var T=s.tag;if(T&&(!s.closed||s.endTagStart>k)){var f={label:"/"+T,kind:n.CompletionItemKind.Property,filterText:"/"+T+i,textEdit:n.TextEdit.replace(o,"/"+T+i),insertTextFormat:n.InsertTextFormat.PlainText},c=y(s.start),d=y(e-1);if(null!==c&&null!==d&&c!==d){var E=c+"</"+T+i;f.textEdit=n.TextEdit.replace(S(e-1-d.length),E),f.filterText=d+"</"+T+i}return l.items.push(f),l}s=s.parent}return t?l:(g.forEach((function(e){e.collectTags((function(e,t){l.items.push({label:"/"+e,kind:n.CompletionItemKind.Property,documentation:t,filterText:"/"+e+i,textEdit:n.TextEdit.replace(o,"/"+e+i),insertTextFormat:n.InsertTextFormat.PlainText})}))})),l)}function O(t,r){if(d&&d.hideAutoCompleteProposals)return l;if(!a.isEmptyElement(r)){var o=e.positionAt(t);l.items.push({label:"</"+r+">",kind:n.CompletionItemKind.Property,filterText:"</"+r+">",textEdit:n.TextEdit.insert(o,"$0</"+r+">"),insertTextFormat:n.InsertTextFormat.Snippet})}return l}function A(e,t){return h(e,t),b(e,!0,t),l}function C(e,t){void 0===t&&(t=k);for(var a=k;a<t&&"<"!==p[a];)a++;var o=S(e,a),i=u(p,t,r.ScannerState.AfterAttributeName,r.TokenType.DelimiterAssign)?"":'="$1"',f=v.toLowerCase();return g.forEach((function(e){e.collectAttributes(f,(function(e,t){var r,a=e;"v"!==t&&i.length&&(a+=i,t&&(r={title:"Suggest",command:"editor.action.triggerSuggest"})),l.items.push({label:e,kind:"handler"===t?n.CompletionItemKind.Function:n.CompletionItemKind.Value,textEdit:n.TextEdit.replace(o,a),insertTextFormat:n.InsertTextFormat.Snippet,command:r})}))})),function(e){var t="data-",r={};r[t]=t+'$1="$2"',s&&s.roots.forEach((function(e){return function e(n){n.attributeNames.forEach((function(e){T.startsWith(e,t)&&!r[e]&&(r[e]=e+'="$1"')})),n.children.forEach((function(t){return e(t)}))}(e)}));Object.keys(r).forEach((function(t){return l.items.push({label:t,kind:n.CompletionItemKind.Value,textEdit:n.TextEdit.replace(e,r[t]),insertTextFormat:n.InsertTextFormat.Snippet})}))}(o),l}function I(e,t){var r,a;if(void 0===t&&(t=k),k>e&&k<=t&&'"'===p[e]){t>k&&'"'===p[t-1]&&t--;var o=function(e,t,n){for(;t>n&&!c(e[t-1]);)t--;return t}(p,k,e+1),i=function(e,t,n){for(;t<n&&!c(e[t]);)t++;return t}(p,k,t);r=S(o,i),a=!1}else r=S(e,t),a=!0;var s=v.toLowerCase(),T=E.toLowerCase();return g.forEach((function(e){e.collectValues(s,T,(function(e){var t=a?'"'+e+'"':e;l.items.push({label:e,filterText:t,kind:n.CompletionItemKind.Unit,textEdit:n.TextEdit.replace(r,t),insertTextFormat:n.InsertTextFormat.PlainText})}))})),K(),l}function F(e){return k===x.getTokenEnd()&&(N=x.scan())===e&&x.getTokenOffset()===k?x.getTokenEnd():k}function P(){return K()}function K(){for(var e=k-1,r=t.character;e>=0&&T.isLetterOrDigit(p,e);)e--,r--;if(e>=0&&"&"===p[e]){var a=n.Range.create(n.Position.create(t.line,r-1),t);for(var o in i.entities)if(T.endsWith(o,";")){var s="&"+o;l.items.push({label:s,kind:n.CompletionItemKind.Keyword,documentation:f("entity.propose","Character entity representing '"+i.entities[o]+"'"),textEdit:n.TextEdit.replace(a,s),insertTextFormat:n.InsertTextFormat.PlainText})}}return l}for(var N=x.scan();N!==r.TokenType.EOS&&x.getTokenOffset()<=k;){switch(N){case r.TokenType.StartTagOpen:if(x.getTokenEnd()===k){var W=F(r.TokenType.StartTag);return A(k,W)}break;case r.TokenType.StartTag:if(x.getTokenOffset()<=k&&k<=x.getTokenEnd())return h(x.getTokenOffset(),x.getTokenEnd());v=x.getTokenText();break;case r.TokenType.AttributeName:if(x.getTokenOffset()<=k&&k<=x.getTokenEnd())return C(x.getTokenOffset(),x.getTokenEnd());E=x.getTokenText();break;case r.TokenType.DelimiterAssign:if(x.getTokenEnd()===k)return I(x.getTokenEnd());break;case r.TokenType.AttributeValue:if(x.getTokenOffset()<=k&&k<=x.getTokenEnd())return I(x.getTokenOffset(),x.getTokenEnd());break;case r.TokenType.Whitespace:if(k<=x.getTokenEnd())switch(x.getScannerState()){case r.ScannerState.AfterOpeningStartTag:return A(x.getTokenOffset(),F(r.TokenType.StartTag));case r.ScannerState.WithinTag:case r.ScannerState.AfterAttributeName:return C(x.getTokenEnd());case r.ScannerState.BeforeAttributeValue:return I(x.getTokenEnd());case r.ScannerState.AfterOpeningEndTag:return b(x.getTokenOffset()-1,!1);case r.ScannerState.WithinContent:return P()}break;case r.TokenType.EndTagOpen:if(k<=x.getTokenEnd())return b(x.getTokenOffset()+1,!1,F(r.TokenType.EndTag));break;case r.TokenType.EndTag:if(k<=x.getTokenEnd())for(var $=x.getTokenOffset()-1;$>=0;){var w=p.charAt($);if("/"===w)return b($,!1,x.getTokenEnd());if(!c(w))break;$--}break;case r.TokenType.StartTagClose:if(k<=x.getTokenEnd()&&v)return O(x.getTokenEnd(),v);break;case r.TokenType.Content:if(k<=x.getTokenEnd())return P();break;default:if(k<=x.getTokenEnd())return l}N=x.scan()}return l},t.doTagComplete=function(e,t,n){var o=e.offsetAt(t);if(o<=0)return null;var i=e.getText().charAt(o-1);if(">"===i){if((T=n.findNodeBefore(o))&&T.tag&&!a.isEmptyElement(T.tag)&&T.start<o&&(!T.endTagStart||T.endTagStart>o))for(var s=(f=r.createScanner(e.getText(),T.start)).scan();s!==r.TokenType.EOS&&f.getTokenEnd()<=o;){if(s===r.TokenType.StartTagClose&&f.getTokenEnd()===o)return"$0</"+T.tag+">";s=f.scan()}}else if("/"===i){for(var T=n.findNodeBefore(o);T&&T.closed;)T=T.parent;if(T&&T.tag){var f;for(s=(f=r.createScanner(e.getText(),T.start)).scan();s!==r.TokenType.EOS&&f.getTokenEnd()<=o;){if(s===r.TokenType.EndTagOpen&&f.getTokenEnd()===o)return T.tag+">";s=f.scan()}}}return null}}));